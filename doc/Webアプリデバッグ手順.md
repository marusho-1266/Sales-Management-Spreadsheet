# Google Apps Script Webアプリ デバッグ手順

## 問題の症状

- PythonスクリプトからGoogle Apps ScriptのWebアプリを呼び出しているが、スプレッドシートが更新されない
- GASの実行ログに何も残っていない
- HTMLページが返ってくる（JSONではなく）

## 原因の可能性

1. **Webアプリのデプロイ設定が正しくない**
   - 認証設定の問題
   - アクセス権限の問題

2. **`doGet`関数が実行されていない**
   - 関数名が間違っている
   - デプロイ設定で関数が指定されていない

3. **URLパラメータのサイズ制限**
   - URLパラメータが長すぎる（約2000文字制限）

## デバッグ手順

### ステップ1: 簡単なテスト関数で確認

1. Google Apps Scriptエディタを開く
2. `src/WebScrapingDirectUpdate.gs`を開く
3. `doGet`関数を一時的に`doGetTest`に変更：

```javascript
function doGet(e) {
  return doGetTest(e);
}
```

4. 「デプロイ」→「デプロイを管理」→既存のデプロイを選択→「新しいバージョンを保存」
5. ブラウザでWebアプリURLにアクセス（パラメータなし）
6. JSONが返ってくるか確認

**期待される結果**: 
```json
{
  "success": true,
  "message": "doGet関数は正常に動作しています",
  "parameters": {},
  "timestamp": "2025-12-24T..."
}
```

### ステップ2: 実行ログを確認

1. Google Apps Scriptエディタで「表示」→「ログ」を開く
2. Pythonスクリプトを実行
3. ログに何か出力されるか確認

**ログに何も出ない場合**: `doGet`関数が実行されていない可能性が高い

### ステップ3: Webアプリのデプロイ設定を確認

1. 「デプロイ」→「デプロイを管理」を開く
2. 既存のデプロイを選択→「編集」をクリック
3. 以下の設定を確認：

   - **種類**: ウェブアプリ
   - **説明**: 任意
   - **次のユーザーとして実行**: **自分**
   - **アクセスできるユーザー**: **全員**（または特定のユーザー）
   - **関数**: `doGet`

4. 「デプロイ」をクリック

### ステップ4: 認証の確認

1. WebアプリURLにブラウザで直接アクセス
2. 認証画面が表示されるか確認
3. 認証を許可
4. JSONが返ってくるか確認

### ステップ5: ファイルID経由の方法を試す

URLパラメータのサイズ制限を回避するため、Google DriveにファイルをアップロードしてファイルIDを渡す方法を試す：

1. Pythonスクリプトを実行
2. Google Driveへのアップロードが成功するか確認
3. ファイルIDが取得できるか確認
4. WebアプリURLに`?fileId=FILE_ID`を追加してアクセス

## トラブルシューティング

### 問題1: HTMLが返ってくる

**原因**: Webアプリのデプロイ設定が正しくない、または認証の問題

**解決策**:
1. Webアプリのデプロイ設定を確認（ステップ3）
2. 認証を確認（ステップ4）
3. 新しいデプロイを作成してみる

### 問題2: 実行ログに何も出ない

**原因**: `doGet`関数が実行されていない

**解決策**:
1. 関数名が`doGet`であることを確認
2. デプロイ設定で関数が`doGet`に設定されているか確認
3. `doGetTest`関数でテスト（ステップ1）

### 問題3: URLパラメータが長すぎる

**原因**: CSVデータがURLパラメータのサイズ制限（約2000文字）を超えている

**解決策**:
1. Google DriveにファイルをアップロードしてファイルIDを渡す方法を使用
2. `upload_csv_to_drive`関数が正しく動作するか確認

### 問題4: ファイルIDが取得できない

**原因**: Google Driveへのアップロードが失敗している

**解決策**:
1. ブラウザでGoogle Driveに手動でログインしているか確認
2. SeleniumのChromeプロファイルが正しく設定されているか確認
3. ファイルアップロードの待機時間を増やす

## 推奨される解決策

最も確実な方法は、**Google DriveにCSVファイルをアップロードしてファイルIDを渡す方法**です。

この方法のメリット:
- ✅ URLパラメータのサイズ制限を回避
- ✅ より確実に動作する
- ✅ エラーハンドリングが容易

実装は既に`inventory_scraper/src/spreadsheet_updater.py`に含まれています。

---

**作成日**: 2025-12-24  
**最終更新**: 2025-12-24

