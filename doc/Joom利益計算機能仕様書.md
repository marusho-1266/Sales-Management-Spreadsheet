# Joom利益計算機能 仕様書（事前利益計算特化版）

## 1. 概要

### 1.1 目的
Joomでの商品登録時における価格決定を支援するため、DDP（Delivered Duty Paid）要件に対応した、シンプルかつ正確な事前利益計算ツールを構築する。

### 1.2 背景
- Joomは2021年以降、EU圏の新ルールに対応するため全配送をDDPで統一
- カテゴリー別関税率の複雑な計算が必要
- 複数の配送方法（Joom Logistics、DDP直送等）の選択とコスト比較が重要
- 在庫管理シートでの商品登録時の価格決定支援が求められる

### 1.3 対象範囲
- 在庫管理シートでの商品登録時の利益計算
- 事前の利益計算シートでの価格シミュレーション
- 複数配送業者・地域での送料比較
- DDP対応の関税込み利益計算

## 2. システム構成

### 2.1 シート構成
売上管理シートを削減し、まずは事前計算に必要なシートに絞ります。
```
1. 利益計算シート - メインの利益計算UI
2. Joom送料マスタ - 配送業者別・地域別送料設定
3. 関税率マスタ - カテゴリー別・地域別関税率
5. 在庫管理シート - 商品登録・利益反映
6. 価格計算設定シート - 価格計算に関する各種パラメータ設定
7. システム設定シート（既存設定シートに統合） - システム動作に関する設定
8. 為替レートシート - 為替レートの取得・管理
```

### 2.2 主要機能
- リアルタイム利益計算
- 複数配送方法の比較
- DDP料金の自動計算
- 地域別価格設定基準の提案
- 利益計算結果の在庫管理シートへの反映

## 3. データ構造

### 3.1 利益計算シート

#### 3.1.0 座標系とグリッドレイアウト定義

**座標系の定義**:
- セル参照形式: `B5` = Column B (2列目), Row 5 (5行目)
- 範囲参照形式: `B5:E10` = Column B-E, Row 5-10
- 絶対参照形式: `$B$5` = 固定座標B5
- 相対参照形式: `B5` = 現在位置からの相対座標

**シート全体のグリッドレイアウト**:
```
総サイズ: 50行 × 26列 (A-Z)
注: 25-34行目を削除し、以降のセクションを10行繰り上げました
列幅: A列(15px), B列(120px), C列(80px), D列(100px), E列(120px), F列(80px), G-Z列(60px)
行高: ヘッダー行(30px), データ行(25px), 計算結果行(30px)
```

**セクション別の具体的なセル範囲**:
```
行1-3: ヘッダーセクション (A1:Z3)
行4-6: 出品情報セクション (A4:Z6)
行7-25: 利益計算セクション (A7:Z25)
行26-30: DDP対応・地域別設定セクション (A26:Z30)
行31-35: 商品カテゴリー・関税設定セクション (A31:Z35)
行36-40: 為替レート管理セクション (A36:Z40)
行41-50: 予備・拡張領域 (A41:Z50)
```

#### 3.1.0.1 マルチユーザー編集対応戦略

**並行性制御**:
- **最大同時ユーザー数**: 10ユーザー
- **編集ロック方式**: Google Sheets保護範囲 + 行レベルロック
- **競合解決ポリシー**: 最後の保存が優先（Last Writer Wins）

**保護範囲の設定**:
```
計算結果セル（読み取り専用）:
- 利益額: B8, B10
- 利益率: B9, B11
- 送料: E16
- Joom手数料: E17
- DDP料金: B34
- 容積重量: D21

入力可能セル（編集可能）:
- 商品情報: B5, E5, B6, E6
- 価格情報: B12, E12, B13, E13, B14
- 重量・寸法: B15, E15, B16, B20, D20, B21
- 返金額: B18
```

**行レベルロック戦略**:
```
ロック対象行:
- 行8-11: 利益計算結果行（計算中は編集禁止）
- 行16-17: 送料・手数料計算結果行
- 行21: 容積重量計算結果行
- 行34: DDP料金計算結果行

ロック解除条件:
- 計算処理完了時
- エラー発生時（5秒後に自動解除）
- 手動ロック解除（管理者権限）
```

**競合解決ポリシー**:
```
データ競合時の処理:
1. 同時編集検出 → 警告メッセージ表示
2. ユーザー選択: 上書き/取り消し/手動マージ
3. デフォルト: 最後の保存を優先
4. 重要な計算結果: 再計算実行

マージ解決手順:
1. 変更履歴の確認
2. 競合セルの特定
3. ユーザーへの選択肢提示
4. 解決後の整合性チェック
```

#### 3.1.0.2 シート間参照方法と関数仕様

**参照方法の優先順位**:
```
1. 名前付き範囲（Named Ranges） - 推奨
2. INDEX/MATCH関数 - 高パフォーマンス
3. VLOOKUP関数 - シンプルな参照
4. IMPORTRANGE関数 - 外部スプレッドシート参照
```

**具体的な参照実装例**:

**送料マスタ参照**:
```javascript
// 推奨: 名前付き範囲 + INDEX/MATCH
=INDEX(送料マスタ_地域別, MATCH(発送方法, 送料マスタ_配送方法, 0), MATCH(配送地帯, 送料マスタ_地域, 0))

// 代替: VLOOKUP（単一条件）
=VLOOKUP(発送方法, 送料マスタ!B:U, 7, FALSE) // EU送料列

// 代替: IMPORTRANGE（外部参照）
=IMPORTRANGE("スプレッドシートID", "送料マスタ!G2:G100")
```

**関税率マスタ参照**:
```javascript
// 推奨: INDEX/MATCH（複数条件）
=INDEX(関税率マスタ_税率, MATCH(商品カテゴリー, 関税率マスタ_カテゴリー, 0), MATCH(配送地帯, 関税率マスタ_地域, 0))

// 代替: VLOOKUP
=VLOOKUP(商品カテゴリー, 関税率マスタ!B:J, 4, FALSE) // EU関税率列
```

**為替レート参照**:
```javascript
// 推奨: 名前付き範囲
=為替レート_USDJPY

// 代替: 直接参照
=為替レートシート!B2

// 代替: GoogleFinance関数
=GOOGLEFINANCE("CURRENCY:USDJPY")
```

**名前付き範囲の定義例**:
```
送料マスタ_配送方法: 送料マスタ!B2:B100
送料マスタ_地域別: 送料マスタ!G2:M100
関税率マスタ_カテゴリー: 関税率マスタ!B2:B100
関税率マスタ_税率: 関税率マスタ!D2:J100
Joom手数料マスタ_カテゴリー: Joom手数料マスタ!B2:B100
Joom手数料マスタ_手数料率: Joom手数料マスタ!D2:J100
為替レート_USDJPY: 為替レートシート!B2
```

**エラーハンドリング**:
```javascript
// 参照エラー時のフォールバック
=IFERROR(INDEX(送料マスタ_地域別, MATCH(発送方法, 送料マスタ_配送方法, 0), MATCH(配送地帯, 送料マスタ_地域, 0)), 0)

// データが見つからない場合のデフォルト値
=IF(ISNA(MATCH(商品カテゴリー, 関税率マスタ_カテゴリー, 0)), 10%, INDEX(関税率マスタ_税率, MATCH(商品カテゴリー, 関税率マスタ_カテゴリー, 0), MATCH(配送地帯, 関税率マスタ_地域, 0)))
```

#### 3.1.0.3 実装検証チェックリスト

**セル参照の検証**:
```
□ B5: Joom商品SKU - 商品識別コード入力セル
□ E5: 商品名 - 商品名称表示セル
□ B6: 仕入URL - 仕入れ先URL入力セル
□ E6: 仕入元 - 仕入れ先名表示セル
□ B8: 利益額(¥) - 自動計算結果（黄色ハイライト）
□ B9: 利益率(%) - 自動計算結果（黄色ハイライト）
□ B10: 還付込利益額(¥) - 返金考慮後利益（黄色ハイライト）
□ B11: 還付込利益率(%) - 返金考慮後利益率（黄色ハイライト）
□ B12: 販売価格(¥) - 手動入力セル
□ E12: 出品数量 - 手動入力セル
□ B13: 仕入価格(¥) - 手動入力セル
□ E13: 割引率(%) - 手動入力セル
□ B14: 割引ポイント - 手動入力セル
□ E14: 仕入原価(¥) - 自動計算セル
□ B15: 重量(g) - 手動入力セル
□ E15: 発送方法 - ドロップダウン選択セル
□ B16: 配送地帯 - ドロップダウン選択セル
□ E16: 送料(¥) - 自動計算セル
□ B17: Joom手数料率(%) - 自動取得セル（カテゴリーB32×配送地帯B16からJoom手数料マスタを参照、デフォルト値12.7%）
□ E17: Joom手数料(¥) - 自動計算セル
□ B18: 返金額(¥) - 手動入力セル
□ B20: 高さ(cm) - 手動入力セル
□ D20: 長さ(cm) - 手動入力セル
□ B21: 幅(cm) - 手動入力セル
□ D21: 容積重量(g) - 自動計算セル
```

**計算式の検証**:
```
□ 仕入原価計算: E14 = B13 × (1 - E13/100) - B14
□ 利益額計算: B8 = B12 - E14 - E16 - E17 + B18
□ 利益率計算: B9 = (B8 / B12) × 100
□ 還付込利益額計算: B10 = B8 + B18
□ 還付込利益率計算: B11 = (B10 / B12) × 100
□ 容積重量計算: D21 = B20 × D20 × B21 ÷ 係数
□ 送料計算: E16 = 送料マスタ参照（発送方法、配送地帯）
□ Joom手数料計算: E17 = B12 × B17 / 100（B17はJoom手数料マスタから自動取得）
```

**ドロップダウン検証**:
```
□ E15: 発送方法 - 送料マスタの配送方法名から選択
□ B16: 配送地帯 - 定義済み地域リストから選択
□ B27: 販売ターゲット地域 - B16（配送地帯）から自動取得（統一）
□ B32: 商品カテゴリー - 関税率マスタのカテゴリーから選択
```

**参照の整合性検証**:
```
□ 送料マスタ参照: E15 → 送料マスタ!B列 → E16
□ 関税率マスタ参照: B32 → 関税率マスタ!B列 → B33
□ Joom手数料マスタ参照: B32×B16 → Joom手数料マスタ!B列×D-J列 → B17
□ 為替レート参照: 為替レートシート!B2 → 価格計算設定シート
```

**エラーハンドリング検証**:
```
□ 参照エラー: #N/A → デフォルト値表示
□ 計算エラー: #DIV/0! → エラーメッセージ表示
□ 入力値エラー: 数値以外 → 警告表示
□ 重量制限エラー: 上限超過 → 警告表示
□ DDP非対応エラー: EU圏+DDP非対応 → 警告表示
```

**パフォーマンス検証**:
```
□ 計算時間: 3秒以内
□ 参照速度: 1秒以内
□ 同時ユーザー: 10ユーザー対応
□ データ整合性: リアルタイム検証
□ ロック解除: 5秒以内
```

#### 3.1.0.4 イベントコーディネーターモデルと実行制御

**実行制御システムの概要**:
```
従来の問題点:
- 複数セル同時変更時の重複実行
- 実行順序の不確定性
- 無限ループのリスク
- パフォーマンス低下

新しいアプローチ:
- イベントコーディネーターモデル
- 決定論的実行順序
- デバウンス・バッチ処理
- ループ防止メカニズム
```

**イベントコーディネーターモデル**:
```javascript
// メインイベントハンドラー
function onEdit(e) {
  // 1. 編集イベントの収集・バッチ化
  const eventBatch = collectEditEvents(e);
  
  // 2. 変更セルの分析
  const affectedModules = analyzeAffectedModules(eventBatch);
  
  // 3. 実行順序の決定
  const executionOrder = determineExecutionOrder(affectedModules);
  
  // 4. デバウンス処理
  scheduleExecution(executionOrder, 300); // 300msデバウンス
}

// 実行モジュールの定義
const CALCULATION_MODULES = {
  SHIPPING: '送料計算',
  COST: '仕入原価計算', 
  PROFIT: '基本利益計算',
  DDP: 'DDP計算'
};
```

**決定論的実行順序**:
```
実行順序（依存関係に基づく）:
1. 送料計算 (SHIPPING)
   ├─ 入力: 重量、発送方法、配送地帯、寸法
   └─ 出力: 送料(E16)、容積重量(D21)

2. 仕入原価計算 (COST)
   ├─ 入力: 仕入価格、割引率、割引ポイント
   └─ 出力: 仕入原価(E14)

3. 基本利益計算 (PROFIT)
   ├─ 入力: 販売価格、仕入原価、送料、手数料、返金額
   └─ 出力: 利益額(B8,B10)、利益率(B9,B11)

4. DDP計算 (DDP)
   ├─ 入力: 販売価格、送料、商品カテゴリー、配送地帯
   └─ 出力: DDP料金(B34)、関税（送料+関税）
```

**デバウンス・バッチ処理**:
```javascript
// デバウンス設定
const DEBOUNCE_CONFIG = {
  WINDOW_MS: 300,        // 300msデバウンスウィンドウ
  MAX_BATCH_SIZE: 50,    // 最大バッチサイズ
  LOCK_TIMEOUT_MS: 30000 // ロックタイムアウト30秒
};

// LockServiceによる排他制御
function executeCalculationBatch(modules) {
  const lock = LockService.getScriptLock();
  try {
    if (lock.tryLock(DEBOUNCE_CONFIG.LOCK_TIMEOUT_MS)) {
      executeModulesInOrder(modules);
    } else {
      Logger.log('計算実行中です。しばらく待ってから再試行してください。');
    }
  } finally {
    lock.releaseLock();
  }
}
```

**ループ防止メカニズム**:
```javascript
// changeSource flagによるループ防止
const CHANGE_SOURCES = {
  USER_INPUT: 'user_input',      // ユーザー入力
  PROGRAMMATIC: 'programmatic',   // プログラム実行
  FORMULA: 'formula'             // 数式計算
};

// セル更新時のメタデータ付与
function updateCellWithMetadata(cell, value, source) {
  const cellWithMetadata = {
    value: value,
    changeSource: source,
    timestamp: new Date().getTime()
  };
  
  // メタデータを隠しセルに保存
  saveCellMetadata(cell.getA1Notation(), cellWithMetadata);
  
  // プログラム実行時はトリガーを無効化
  if (source === CHANGE_SOURCES.PROGRAMMATIC) {
    disableTriggers();
    cell.setValue(value);
    enableTriggers();
  } else {
    cell.setValue(value);
  }
}
```

#### 3.1.1 出品情報セクション
| 項目 | 列 | 説明 |
|------|-----|------|
| Joom商品SKU | B5 | 商品識別コード |
| 商品名 | E5 | 商品名称 |
| 仕入URL | B6 | 仕入れ先URL |
| 仕入元 | E6 | 仕入れ先名 |

#### 3.1.2 利益計算セクション
| 項目 | 列 | 説明 |
|------|-----|------|
| 利益額(¥) | B8 | 自動計算結果（黄色ハイライト） |
| 利益率(%) | B9 | 自動計算結果（黄色ハイライト） |
| 還付込利益額(¥) | B10 | 返金考慮後利益（黄色ハイライト） |
| 還付込利益率(%) | B11 | 返金考慮後利益率（黄色ハイライト） |
| 販売価格(¥) | B12 | 手動入力 |
| 出品数量 | E12 | 手動入力 |
| 仕入価格(¥) | B13 | 手動入力 |
| 割引率(%) | E13 | 手動入力 |
| 割引ポイント | B14 | 手動入力 |
| 仕入原価(¥) | E14 | 自動計算 |
| 重量(g) | B15 | 手動入力 |
| 発送方法 | E15 | ドロップダウン選択 |
| 配送地帯 | B16 | ドロップダウン選択 |
| 送料(¥) | E16 | 自動計算 |
| Joom手数料率(%) | B17 | 自動取得（カテゴリー×地域からJoom手数料マスタを参照、デフォルト12.7%） |
| Joom手数料(¥) | E17 | 自動計算 |
| 返金額(¥) | B18 | 手動入力 |

#### 3.1.3 容積重量チェックサブセクション
| 項目 | 列 | 説明 |
|------|-----|------|
| 高さ(cm) | B20 | 手動入力 |
| 長さ(cm) | D20 | 手動入力 |
| 幅(cm) | B21 | 手動入力 |
| 容積重量(g) | D21 | 自動計算 |

**容積重量計算式**:
```
容積重量(g) = 長さ(cm) × 幅(cm) × 高さ(cm) ÷ 係数
```

**配送業者別容積重量係数**:
- **Joom Logistics**: 6000
- **eLogi DDP**: 5000
- **DHL**: 5000
- **FedEx**: 5000
- **UPS**: 5000
- **西濃運輸**: 3571 (1m³=280kg換算)
- **日本通運**: 6000

**重量判定ロジック**:
- 発送方法選択時に該当する配送業者の係数が自動適用
- 送料計算時は「実重量」と「容積重量」の大きい方を使用

#### 3.1.4 DDP対応・地域別設定セクション
| 項目 | 列 | 説明 |
|------|-----|------|
| 販売ターゲット地域 | B27 | B16（配送地帯）から自動取得（数式：=B16） |
| 推奨配送方法 | B28 | 自動表示 |
| 利用可能配送方法 | B29 | 自動表示 |
| DDP対応警告 | B30 | 自動警告表示 |

#### 3.1.5 商品カテゴリー・関税設定セクション
| 項目 | 列 | 説明 |
|------|-----|------|
| 商品カテゴリー | B32 | ドロップダウン選択 |
| 関税率(%) | B33 | 自動取得 |
| DDP料金(¥) | B34 | 自動計算（黄色ハイライト、送料+関税） |

### 3.2 Joom送料マスタ
| 列 | 項目 | 説明 |
|----|------|------|
| A | 配送方法ID | 配送方法の一意識別子 |
| B | 配送方法名 | 配送業者名 |
| C | 配送タイプ | 香港倉庫/DDP直送/郵便局 |
| D | DDP対応 | TRUE/FALSE |
| E | 対応地域 | 対応可能な地域 |
| F | 重量上限(g) | 重量制限 |
| G | EU送料(¥) | EU圏送料 |
| H | ロシア送料(¥) | ロシア送料 |
| I | 東欧送料(¥) | 東欧送料 |
| J | 北米送料(¥) | 北米送料 |
| K | アジア送料(¥) | アジア送料 |
| L | オセアニア送料(¥) | オセアニア送料 |
| M | 南米送料(¥) | 南米送料 |
| N | Joom手数料率(%) | Joom手数料率（**注：詳細なカテゴリー×地域別手数料率は「Joom手数料マスタ」で管理**） |
| O | 代行手数料(¥) | DDP直送時の代行手数料 |
| P | 関税込み | TRUE/FALSE |
| Q | 追跡可能 | TRUE/FALSE |
| R | 納期(日) | 配送日数 |
| S | 有効フラグ | TRUE/FALSE |
| T | 備考 | 備考・注意事項 |
| U | 容積重量係数 | 容積重量計算用の係数（6000, 5000, 3571等） |

### 3.3 関税率マスタ
| 列 | 項目 | 説明 |
|----|------|------|
| A | カテゴリーID | カテゴリーの一意識別子 |
| B | カテゴリー名 | カテゴリー名称 |
| C | 商品説明 | カテゴリーの詳細説明 |
| D | EU関税率(%) | EU圏関税率 |
| E | ロシア関税率(%) | ロシア関税率 |
| F | 東欧関税率(%) | 東欧関税率 |
| G | 北米関税率(%) | 北米関税率 |
| H | アジア関税率(%) | アジア関税率 |
| I | オセアニア関税率(%) | オセアニア関税率 |
| J | 南米関税率(%) | 南米関税率 |
| K | アフリカ関税率(%) | アフリカ関税率 |
| L | 更新日時 | データ更新日時 |
| M | 有効フラグ | TRUE/FALSE |
| N | 備考 | 備考・注意事項 |

### 3.4 Joom手数料マスタ
Joomプラットフォームへの手数料率をカテゴリー×地域の組み合わせで管理するマスタシート。

| 列 | 項目 | 説明 |
|----|------|------|
| A | カテゴリーID | カテゴリーの一意識別子 |
| B | カテゴリー名 | カテゴリー名称（関税率マスタと一致） |
| C | 商品説明 | カテゴリーの詳細説明（オプション） |
| D | EU圏手数料率(%) | EU圏向けのJoom手数料率 |
| E | ロシア手数料率(%) | ロシア向けのJoom手数料率 |
| F | 東欧手数料率(%) | 東欧向けのJoom手数料率 |
| G | 北米手数料率(%) | 北米向けのJoom手数料率 |
| H | アジア手数料率(%) | アジア向けのJoom手数料率 |
| I | オセアニア手数料率(%) | オセアニア向けのJoom手数料率 |
| J | 南米手数料率(%) | 南米向けのJoom手数料率 |
| K | 更新日時 | データ更新日時 |
| L | 有効フラグ | TRUE/FALSE |
| M | 備考 | 備考・注意事項 |

**参照方法**:
- 利益計算シートのB17（Joom手数料率）で、商品カテゴリー（B32）と配送地帯（B16）から手数料率を取得
- 数式: `=IFERROR(INDEX(Joom手数料マスタ!D:J,MATCH(B32,Joom手数料マスタ!B:B,0),MATCH(B16,Joom手数料マスタ!D1:J1,0))/100,0.127)`
- フォールバック: マスタが見つからない場合はデフォルト値12.7%（0.127）を使用

**名前付き範囲**:
- `Joom手数料マスタ_カテゴリー`: B列（カテゴリー名）
- `Joom手数料マスタ_手数料率`: D-J列（各地域の手数料率）

### 3.5 価格計算設定シート
Joomでの販売における価格計算に必要な各種パラメータを一元管理するシート。

| 項目 | 列 | 説明 |
|------|-----|------|
| 最新為替レート (USD/JPY) | A | 最新の自動取得為替レート（USD/JPY）。Joomの販売価格・手数料が外貨建ての場合の円換算に使用。 |
| 出品管理為替レート (USD/JPY) | B | 出品管理時に使用する為替レート。手動設定が有効な場合に適用。 |
| 為替レート手動設定 (オン/オフ) | C | 為替レートを手動で設定するかどうかのトグル。オンの場合、出品管理為替レートが優先される。 |
| 一般関税率 (%) | D | 商品カテゴリーや地域に依存しない一般的な関税率。DDP計算のデフォルト値として使用される場合がある。**（注：詳細な関税率は「関税率マスタ」で管理）** |
| 諸費用 (%) | E | 商品固有の追加コスト（梱包材、ラベル等）の割合。 |
| 諸費用 (¥) | F | 商品固有の追加コスト（梱包材、ラベル等）の固定額。 |
| FedEx燃油サーチャージ率 (%) | G | FedEx利用時の燃油サーチャージ率。**（注：詳細な配送業者別燃油サーチャージは「Joom送料マスタ」で管理）** |
| DHL燃油サーチャージ率 (%) | H | DHL利用時の燃油サーチャージ率。**（注：詳細な配送業者別燃油サーチャージは「Joom送料マスタ」で管理）** |
| Joom手数料率 (%) | I | Joomプラットフォームに支払う手数料率。**（注：詳細なカテゴリー×地域別手数料率は「Joom手数料マスタ」で管理）** |
| 海外販売手数料 (%) | J | Joomプラットフォーム手数料とは別に発生する海外販売に関する手数料率。 |
| Payoneer決済手数料 (%) | K | Payoneer等の決済サービスに支払う手数料率。 |
| 繁忙期追加金 (オン/オフ) | L | 繁忙期に発生する追加コストの有無。オンの場合、繁忙期追加金額が適用される。 |
| 繁忙期追加金額 (¥) | M | 繁忙期に追加される固定コスト。 |
| 更新日時 | N | 設定が最終更新された日時。 |
| 備考 | O | 設定に関するメモ。 |

### 3.6 システム設定シート（既存設定シートに統合）
Joom API連携に関する項目を削除し、利益計算機能に特化した設定のみとします。

利益計算機能設定項目:

| 設定項目 | 設定値 | 説明 |
|----------|--------|------|
| 利益計算 最大同時ユーザー数 | 10 | 同時に編集可能な最大ユーザー数 |
| 利益計算 デバウンス時間（ミリ秒） | 300 | イベント処理のデバウンス時間 |
| 利益計算 ロックタイムアウト（ミリ秒） | 30000 | 排他制御のタイムアウト時間 |
| 利益計算 一般関税率（%） | 10.0 | 商品カテゴリーや地域に依存しない一般的な関税率 |
| 利益計算 諸費用（%） | 5.0 | 商品固有の追加コスト（梱包材、ラベル等）の割合 |
| 利益計算 諸費用固定額（円） | 100 | 商品固有の追加コスト（梱包材、ラベル等）の固定額 |
| 利益計算 FedEx燃油サーチャージ率（%） | 15.0 | FedEx利用時の燃油サーチャージ率 |
| 利益計算 DHL燃油サーチャージ率（%） | 12.0 | DHL利用時の燃油サーチャージ率 |
| 利益計算 Joom手数料率（%） | 12.7 | Joomプラットフォームに支払う手数料率（フォールバック用、詳細はJoom手数料マスタを参照） |
| 利益計算 海外販売手数料（%） | 2.0 | Joomプラットフォーム手数料とは別に発生する海外販売に関する手数料率 |
| 利益計算 Payoneer決済手数料（%） | 1.0 | Payoneer等の決済サービスに支払う手数料率 |
| 利益計算 繁忙期追加金有効化 | false | 繁忙期に発生する追加コストの有無 |
| 利益計算 繁忙期追加金額（円） | 500 | 繁忙期に追加される固定コスト |
| 利益計算 為替レート手動設定 | false | 為替レートを手動で設定するかどうかのトグル |
| 利益計算 出品管理為替レート USD/JPY | 150.00 | 出品管理時に使用する為替レート（手動設定時） |
| システム稼働停止 (オン/オフ) | - | システム全体の自動処理を一時停止するかどうかのトグル |

### 3.7 為替レートシート
GoogleFinance関数を利用した為替レートの取得・管理を行うシート。

| 項目 | 列 | 説明 |
|------|-----|------|
| 通貨ペア | A | 通貨ペア（USD/JPY, EUR/JPY等） |
| 現在レート | B | GoogleFinance関数による現在レート |
| 前日比 | C | 前日との比較 |
| 前日比% | D | 前日との比較率 |
| 更新日時 | E | 最終更新日時 |
| ステータス | F | 取得状況（正常/エラー） |
| 優先度 | G | 取得優先度（隠し列） |

## 4. 機能仕様

### 4.1 利益計算機能

#### 4.1.1 基本利益計算
```javascript
// 基本利益計算式
利益額 = 販売価格 - 仕入原価 - 送料 - Joom手数料 + 返金額
利益率 = (利益額 / 販売価格) × 100
還付込利益額 = 利益額 + 返金額
還付込利益率 = (還付込利益額 / 販売価格) × 100
```

**入力イベント（実行トリガーの入力として扱う）**: 
- 販売価格(B12)、仕入価格(B13)、重量(B15)、発送方法(E15)、配送地帯(B16)のいずれかのセル値を変更した時
- 商品カテゴリー(B32)を選択した時
- 「計算実行」ボタンをクリックした時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接計算を実行しない
- イベントコーディネーターが変更を検知し、影響を受けるモジュールを特定
- 決定論的実行順序に従い、必要な計算モジュールのみを実行
- デバウンス処理（300ms）により、複数変更をバッチ化
- LockServiceによる排他制御で重複実行を防止
- changeSource flagによりプログラム実行時のループを防止

#### 4.1.2 仕入原価計算
```javascript
// 仕入原価計算式
仕入原価 = 仕入価格 × (1 - 割引率/100) - 割引ポイント
```

**入力イベント（実行トリガーの入力として扱う）**: 
- 仕入価格(B13)、割引率(E13)、割引ポイント(B14)のいずれかのセル値を変更した時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接計算を実行しない
- イベントコーディネーターが仕入原価計算モジュールの実行をスケジュール
- 決定論的実行順序では「仕入原価計算」が「基本利益計算」より前に実行される
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

#### 4.1.3 送料計算
```javascript
// 送料計算ロジック
function calculateShippingCost(actualWeight, volumetricWeight, shippingMethod, targetRegion) {
  // 1. 配送方法のDDP対応確認
  // 2. 地域別送料取得
  // 3. 重量制限チェック
  // 4. 重量判定（実重量 vs 容積重量）
  const finalWeight = Math.max(actualWeight, volumetricWeight);
  // 5. 送料計算（最終重量を使用）
}
```

**重量判定ルール**:
- **料金は実重量と容積重量の大きい方を使用**
- 発送方法選択時に該当する配送業者の容積重量係数が自動適用
- 容積重量 = 長さ(cm) × 幅(cm) × 高さ(cm) ÷ 係数
- 最終重量 = max(実重量, 容積重量)

**入力イベント（実行トリガーの入力として扱う）**: 
- 重量(B15)、発送方法(E15)、配送地帯(B16)のいずれかのセル値を変更した時
- 容積重量の寸法（高さ(B20)、長さ(D20)、幅(B21)）を変更した時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接計算を実行しない
- イベントコーディネーターが送料計算モジュールの実行をスケジュール
- 決定論的実行順序では「送料計算」が最初に実行される（他の計算の依存関係）
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

#### 4.1.4 DDP料金計算
```javascript
// DDP料金計算式
関税 = 販売価格 × 関税率 / 100
DDP料金 = 送料 + 関税
```

**入力イベント（実行トリガーの入力として扱う）**: 
- 販売価格(B12)、商品カテゴリー(B32)、配送地帯(B16)のいずれかを変更した時
- 送料(E16)が再計算された時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接計算を実行しない
- イベントコーディネーターがDDP計算モジュールの実行をスケジュール
- 決定論的実行順序では「DDP計算」が最後に実行される（送料・関税の依存関係）
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

### 4.2 配送方法選択機能

#### 4.2.1 地域別推奨配送方法
- **EU・ロシア・東欧**: Joom Logistics推奨
- **グローバル**: eLogi DDP推奨
- **アジア中心**: eLogi DDP推奨

**入力イベント（実行トリガーの入力として扱う）**: 
- 配送地帯(B16)を変更した時（B27は自動で同期）

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接処理を実行しない
- イベントコーディネーターが配送方法推奨ロジックの実行をスケジュール
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

#### 4.2.2 DDP対応チェック
- EU圏配送時はDDP対応配送方法のみ選択可能
- DDP非対応配送方法選択時は警告表示

**入力イベント（実行トリガーの入力として扱う）**: 
- 発送方法(E15)を選択した時
- 配送地帯(B16)を変更した時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接処理を実行しない
- イベントコーディネーターがDDP対応チェックロジックの実行をスケジュール
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

#### 4.2.3 配送方法比較機能
- 複数配送方法の送料・納期・追跡可能性の比較
- 最安値配送方法の自動提案

**入力イベント（実行トリガーの入力として扱う）**: 
- 「配送方法比較」ボタンをクリックした時
- 重量(B15)と配送地帯(B16)の両方が入力された時

**実装要件**:
- 上記イベントは入力イベントとして扱い、直接処理を実行しない
- イベントコーディネーターが配送方法比較ロジックの実行をスケジュール
- デバウンス処理により、複数変更をバッチ化して効率的に実行
- changeSource flagによりプログラム実行時のループを防止

### 4.3 データ連携機能

#### 4.3.1 在庫管理シート連携
- 利益計算結果の在庫管理シートへの手動反映（ボタン操作）
- 商品選択時の基本情報自動取得

**実行トリガー**: 
- 「在庫管理シートへ反映」ボタンをクリックした時
- 商品選択モーダルで商品を選択した時
- SKUを入力した時（自動検索）

#### 4.3.2 利益計算シート連携
- 事前計算結果の在庫管理シートへの反映
- SKU検索による利益計算データの取得

**実行トリガー**: 
- 「利益計算反映」ボタンをクリックした時
- 商品登録フォームでSKUを入力した時

#### 3.1.0.5 イベントコーディネーターモデル実装要件の総括

**重要な実装原則**:
```
1. 「実行トリガー」は入力イベントとして扱う
   - 直接計算を実行しない
   - イベントコーディネーターに処理を委譲

2. 統一されたイベントハンドラー
   - 単一のonEditハンドラーで全イベントを処理
   - 複数セル変更をバッチ化

3. 決定論的実行順序の遵守
   - 送料計算 → 仕入原価計算 → 基本利益計算 → DDP計算
   - 依存関係に基づく実行順序

4. 排他制御とデバウンス
   - LockServiceによる重複実行防止
   - 300msデバウンスウィンドウ

5. ループ防止メカニズム
   - changeSource flagによるプログラム実行時のループ防止
   - メタデータ付与による実行履歴管理
```

**実装時の必須要件**:
```
□ onEditハンドラーの実装
  - イベント収集・バッチ化機能
  - 影響モジュール分析機能
  - 実行順序決定機能

□ デバウンス・バッチ処理の実装
  - 300msデバウンスウィンドウ
  - LockServiceによる排他制御
  - 最大バッチサイズ50の制限

□ ループ防止機能の実装
  - changeSource flag管理
  - セル更新時のメタデータ付与
  - プログラム実行時のトリガー無効化

□ 実行順序制御の実装
  - 依存関係分析機能
  - モジュール実行順序管理
  - エラー時の部分再実行機能
```

### 4.4 設定管理機能

### 4.5 設定管理機能

#### 4.5.1 価格計算設定管理
- 為替レートの手動/自動設定切り替え
- 各種手数料率の設定・更新
- 諸費用・繁忙期追加金の管理
- 燃油サーチャージ率の設定

**実行トリガー**: 
- 設定値を変更して「保存」ボタンをクリックした時
- 設定シートのセル値を直接編集した時

#### 4.4.2 システム設定管理
- システム稼働停止の制御

**実行トリガー**: 
- システム設定を変更して「保存」ボタンをクリックした時

#### 4.5.3 為替レート管理
- GoogleFinance関数による自動取得（メイン方式）
- 為替レートのキャッシュ機能（フォールバック1）
- デフォルト値によるフォールバック（フォールバック2）
- 手動更新機能

**実行トリガー**: 
- スプレッドシートを開いた時（初回読み込み時）
- 定期実行トリガー（60分間隔）
- 「為替レート更新」ボタンをクリックした時
- 為替レート手動設定がオフの状態で利益計算を実行した時



## 5. 計算ロジック

### 5.1 利益計算フロー

#### 5.1.1 事前利益計算フロー（利益計算シート）
```
1. 基本情報入力
   ├─ 商品情報（SKU、商品名、仕入情報）
   ├─ 価格情報（販売価格、仕入価格、割引）
   └─ 配送情報（重量、発送方法、配送地帯）

2. 配送方法検証
   ├─ DDP対応チェック
   ├─ 地域対応チェック
   └─ 重量制限チェック

3. 重量判定（実重量 vs 容積重量）
   ├─ 発送方法から容積重量係数を取得
   ├─ 容積重量計算（長さ×幅×高さ÷係数）
   └─ 最終重量決定（max(実重量, 容積重量)）

4. 送料計算
   ├─ 配送方法別送料取得
   ├─ 最終重量による送料計算
   └─ 代行手数料加算

5. 関税計算
   ├─ カテゴリー別関税率取得
   └─ DDP料金計算

6. 利益計算
   ├─ 総コスト計算
   ├─ 利益額・利益率計算
   └─ 還付込利益計算

7. 結果表示・保存
   ├─ 計算結果の表示
   ├─ 推奨価格の提案
   └─ 在庫管理シートへの反映
```



### 5.2 為替レート取得ロジック
1. 「価格計算設定シート」の「為替レート手動設定」がオンの場合、「出品管理為替レート」を優先。
2. オフの場合、以下の優先順位で為替レートを取得:
   1. GoogleFinance関数 (`=GOOGLEFINANCE("CURRENCY:USDJPY")`など) - **メイン方式**
   2. キャッシュされた為替レート - **フォールバック1**
   3. デフォルト値（例: 150.00 JPY/USD） - **フォールバック2**
3. 取得した為替レートは「価格計算設定シート」の「最新為替レート」に反映。
4. **注意**: 外部APIは使用せず、GoogleFinance関数をメインとし、キャッシュとデフォルト値でフォールバックする設計。

**実行トリガー**: 
- スプレッドシート初回読み込み時
- 定期実行トリガー（60分間隔）
- 手動更新ボタンクリック時
- 利益計算実行時（手動設定がオフの場合）

### 5.3 エラーハンドリング

#### 5.3.1 入力値検証エラー

##### 重量制限超過時
- **対象セル**: B30（DDP対応警告セル）
- **エラーメッセージ**: 「⚠️ 重量が上限を超えています。配送方法を見直してください」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 重量 > 選択された配送方法の重量上限

##### 無効な配送方法選択時
- **対象セル**: B30（DDP対応警告セル）
- **エラーメッセージ**: 「⚠️ 選択された配送方法は配送地帯に対応していません」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 配送地帯と配送方法の組み合わせが無効

##### DDP非対応配送方法選択時（EU圏）
- **対象セル**: B30（DDP対応警告セル）
- **エラーメッセージ**: 「⚠️ EU圏への配送にはDDP対応配送方法が必要です」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 配送地帯 = EU圏 AND DDP対応 = FALSE

##### カテゴリー未選択時
- **対象セル**: B33（関税率セル）
- **エラーメッセージ**: 「商品カテゴリーを選択してください」
- **表示色**: オレンジ色（#ff8800）
- **背景色**: 薄いオレンジ色（#fff2e6）
- **実行条件**: 商品カテゴリー = 空

##### 地域未選択時
- **対象セル**: B16（配送地帯セル、B27は自動取得のため同一）
- **エラーメッセージ**: 「配送地帯を選択してください」
- **表示色**: オレンジ色（#ff8800）
- **背景色**: 薄いオレンジ色（#fff2e6）
- **実行条件**: 配送地帯 = 空

#### 5.3.2 計算エラー

##### 数値計算エラー時
- **対象セル**: B8（利益額セル）
- **エラーメッセージ**: 「計算エラー: 入力値を確認してください」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 数値計算でエラーが発生

##### 為替レート取得失敗時
- **対象セル**: I12（為替レートセル）
- **エラーメッセージ**: 「為替レート取得失敗: デフォルト値を使用」
- **表示色**: オレンジ色（#ff8800）
- **背景色**: 薄いオレンジ色（#fff2e6）
- **実行条件**: GoogleFinance関数失敗 AND キャッシュなし

#### 5.3.3 データ保存エラー

##### 在庫管理シート反映失敗時
- **対象セル**: AI12（反映ステータスセル）
- **エラーメッセージ**: 「反映失敗: 在庫管理シートを確認してください」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 在庫管理シートへの書き込み失敗

##### 設定保存失敗時
- **対象セル**: 各設定シートの最終列
- **エラーメッセージ**: 「設定保存失敗: 権限を確認してください」
- **表示色**: 赤色（#ff4444）
- **背景色**: 薄い赤色（#ffe6e6）
- **実行条件**: 設定シートへの書き込み失敗

#### 5.3.4 エラー表示の統一仕様

#### 5.3.5 エラー表示の統一仕様

##### エラーレベル別色分け
- **重大エラー（赤色）**: 計算不能、データ保存失敗
- **警告（オレンジ色）**: 重量制限超過、為替レート取得失敗
- **情報（青色）**: 推奨事項、注意喚起

##### エラーメッセージ表示形式
```
⚠️ [エラータイプ]: [具体的な内容] - [対処方法]
例: ⚠️ 重量制限超過: 重量が上限を超えています - 配送方法を見直してください
```

##### エラー表示の持続時間
- **入力値エラー**: 入力値修正まで表示継続
- **計算エラー**: 計算成功まで表示継続
- **一時的エラー**: 5秒後に自動消去

**実行トリガー**: 
- 入力値検証時（リアルタイム）
- 計算実行時
- API呼び出し時
- データ保存時

## 6. UI/UX仕様

### 6.1 レイアウト
- セクション分けによる論理的な情報整理
- 色分けによる重要項目のハイライト
- リアルタイム計算結果の表示

### 6.2 入力支援
- ドロップダウンによる選択肢の制限
- データ検証による入力値のチェック
- 自動計算による入力負荷の軽減
- トグルスイッチによる設定の切り替え

### 6.3 視覚的フィードバック
- 利益が正の場合は緑色、負の場合は赤色で表示
- 利益率による色分け（高/中/低/負）
- 警告・エラーメッセージの適切な表示
- 設定項目の有効/無効状態の視覚的表示
- 為替レートの変動状況の表示

#### 6.3.1 エラー表示の視覚的仕様
- **重大エラー**: 赤色文字（#ff4444）+ 薄い赤背景（#ffe6e6）
- **警告**: オレンジ色文字（#ff8800）+ 薄いオレンジ背景（#fff2e6）
- **情報**: 青色文字（#0066cc）+ 薄い青背景（#e6f3ff）
- **成功**: 緑色文字（#00aa00）+ 薄い緑背景（#e6ffe6）

#### 6.3.2 エラーアイコンの使用
- **⚠️**: 警告・注意事項
- **❌**: エラー・失敗
- **ℹ️**: 情報・推奨事項
- **✅**: 成功・完了

### 6.4 設定画面UI
- 価格計算設定とシステム設定の分離
- 設定項目の論理的なグループ化
- 設定値の一覧表示と直接編集
- 設定保存時の確認ダイアログ
- 設定変更履歴の表示

## 7. データ管理

### 7.1 マスタデータ管理
- 送料マスタの定期更新
- 関税率の最新情報維持
- 配送方法の有効性管理
- 価格計算設定の定期更新
- 為替レートの自動取得・更新

**実行トリガー**: 
- マスタデータの手動編集時
- 定期更新処理（日次）
- 設定変更時

### 7.2 履歴管理
- 利益計算履歴の記録
- 価格変更履歴の追跡
- 計算結果の保存・参照
- 設定変更履歴の記録
- 為替レート取得履歴の記録

**実行トリガー**: 
- 計算実行時
- 設定変更時
- データ保存時

### 7.3 バックアップ・復旧
- マスタデータの定期バックアップ
- 計算結果の保存
- エラー時の復旧機能
- 設定データのバックアップ
- 為替レートキャッシュの管理

**実行トリガー**: 
- 定期バックアップ処理（日次）
- エラー発生時
- 手動バックアップ実行時

## 8. セキュリティ・権限

### 8.1 データ保護
- 機密情報の適切な管理
- アクセス権限の制御
- データの暗号化

### 8.2 監査ログ
- 計算実行履歴の記録
- データ変更履歴の追跡
- エラーログの管理
- 設定変更履歴の記録

## 9. パフォーマンス要件

### 9.1 応答時間
- 利益計算: 3秒以内
- 送料計算: 1秒以内
- データ取得: 2秒以内
- 為替レート取得: 5秒以内
- 設定更新: 1秒以内

### 9.2 同時利用
- 最大10ユーザーの同時利用
- データ整合性の維持
- 競合状態の回避
- GoogleFinance関数の制限対応

## 10. 運用要件

### 10.1 メンテナンス
- マスタデータの定期更新
- 計算ロジックの検証
- システム監視・アラート
- GoogleFinance関数の動作監視
- 設定値の妥当性チェック

### 10.2 サポート
- ユーザー操作マニュアル
- トラブルシューティングガイド
- 問い合わせ対応体制
- 設定変更手順書
- GoogleFinance関数エラー対応ガイド

## 11. 今後の拡張性

### 11.1 機能拡張
- Joom API連携: 実際の注文データを元にした「事後利益分析」機能
- 価格最適化機能: 目標利益率から販売価格を自動で逆算する機能
- 高度な分析機能: 商品カテゴリー別、地域別の利益率分析など
- 他ECサイト対応: 他のECプラットフォームへの拡張

### 11.2 データ拡張
- 新しい配送業者の追加
- 追加地域の対応
- カテゴリーの細分化
- 追加通貨ペアの対応
- より詳細な設定項目の追加

---

**作成日**: 2025年10月18日  
**バージョン**: 1.0  
**作成者**: AI Assistant  
**承認者**: [承認者名]
