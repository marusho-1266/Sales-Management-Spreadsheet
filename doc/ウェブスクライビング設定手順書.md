# ウェブスクレイピングシステム 設定手順書

## 目次

1. [前提条件・必要な環境](#前提条件必要な環境)
2. [Python環境のセットアップ](#python環境のセットアップ)
3. [環境変数の設定](#環境変数の設定)
4. [GAS側の設定](#gas側の設定)
5. [Chromeプロファイルの設定](#chromeプロファイルの設定)
6. [動作確認手順](#動作確認手順)
7. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件・必要な環境

### 必要なソフトウェア

- **Python 3.10以上**
  - インストール確認: `python --version` または `python3 --version`
  - ダウンロード: https://www.python.org/downloads/

- **Google Chrome**
  - 最新版をインストール済みであること
  - ダウンロード: https://www.google.com/chrome/

- **Googleアカウント**
  - スプレッドシートへのアクセス権限

### 必要な権限

- スプレッドシートの編集権限

---

## Python環境のセットアップ

### 1. プロジェクトディレクトリに移動

```bash
cd inventory_scraper
```

### 2. 仮想環境の作成（推奨）

#### 2-1. 仮想環境の作成

```bash
# Windowsの場合
# 方法1: pyコマンドを使用（最推奨・最も確実）
py -m venv venv

# 方法2: Pythonのフルパスを指定する
# Pythonのインストールパスを確認してから実行
# 例: C:\Python310\python.exe -m venv venv
# または: C:\Users\Username\AppData\Local\Programs\Python\Python310\python.exe -m venv venv

# 方法3: python3コマンドを使用（WindowsストアのPythonランチャーが原因でエラーになる場合あり）
python3 -m venv venv

# 方法4: pythonコマンドを使用（WindowsストアのPythonランチャーが原因でエラーになる場合あり）
python -m venv venv

# Mac/Linuxの場合
python3 -m venv venv
```

**重要:** Windowsで`python`または`python3`コマンドを実行した際に「Python」とだけ表示される場合は、WindowsストアのPythonランチャーが原因です。**必ず`py`コマンドを使用してください。** `py`コマンドでも問題が発生する場合は、Pythonのフルパスを指定するか、トラブルシューティングセクションを参照してください。

#### 2-2. 仮想環境の有効化（必須）

**重要:** 仮想環境のフォルダ（`venv`）が作成されただけでは、仮想環境は有効化されていません。**必ず以下のコマンドを実行して仮想環境を有効化してください。**

```bash
# Windowsの場合（コマンドプロンプトまたはPowerShell）
venv\Scripts\activate

# Windowsの場合（Git Bash、WSL、MSYS2などのbashシェル）
source venv/Scripts/activate

# Mac/Linuxの場合
source venv/bin/activate
```

**⚠️ よくある間違い（bashシェルを使用している場合）:**
- ❌ **間違い**: `source venv\Scripts\activate`（バックスラッシュ`\`を使用）
- ✅ **正しい**: `source venv/Scripts/activate`（スラッシュ`/`を使用）

bashシェルでは、バックスラッシュ`\`がエスケープ文字として扱われるため、`venv\Scripts\activate`は`venvScriptsactivate`として解釈され、エラーになります。

**シェルの種類の確認方法:**
- コマンドプロンプト: プロンプトが`C:\Users\Username>`のような形式
- PowerShell: プロンプトが`PS C:\Users\Username>`のような形式
- Git Bash/WSL/bash: プロンプトが`$`または`username@hostname:~$`のような形式

**有効化の確認方法:**
- コマンドプロンプトやターミナルのプロンプトの先頭に`(venv)`が表示されます
- 例（コマンドプロンプト）: `(venv) C:\Users\Username\inventory_scraper>`
- 例（bash）: `(venv) username@hostname:~/inventory_scraper$`

**注意:**
- 仮想環境を有効化しないと、`pip install`でインストールしたパッケージはグローバル環境にインストールされ、仮想環境内では使用できません
- 新しいターミナルウィンドウを開いた場合は、再度有効化コマンドを実行する必要があります
- 仮想環境を無効化する場合は、`deactivate`コマンドを実行します
- **bashシェル（Git Bash、WSL、MSYS2など）を使用している場合は、必ずスラッシュ`/`を使用してください**（バックスラッシュ`\`は使用できません）

**既に仮想環境フォルダが存在する場合:**
- `venv`フォルダが既に存在する場合は、作成コマンド（`py -m venv venv`など）を実行する必要はありません
- **仮想環境を有効化するコマンドのみを実行してください:**
  - コマンドプロンプト/PowerShell: `venv\Scripts\activate`
  - bashシェル（Git Bash、WSL、MSYS2など）: `source venv/Scripts/activate`

### 3. 依存パッケージのインストール

**重要:** 仮想環境を有効化した状態で実行してください。

```bash
# 仮想環境が有効化されていることを確認（プロンプトに(venv)が表示される）
# 有効化されていない場合は、以下を実行:
# Windows（コマンドプロンプト/PowerShell）: venv\Scripts\activate
# Windows（Git Bash、WSL、MSYS2などのbashシェル）: source venv/Scripts/activate
# Mac/Linux: source venv/bin/activate

# 依存パッケージをインストール
pip install -r requirements.txt
```

インストールされるパッケージ:
- `selenium` (>=4.15.0) - ブラウザ自動操作
- `webdriver-manager` (>=4.0.1) - ChromeDriver自動管理
- `pandas` (>=2.1.0) - データ処理
- `python-dotenv` (>=1.0.0) - 環境変数管理

### 4. インストール確認

**重要:** 仮想環境を有効化した状態で実行してください。

```bash
# 仮想環境が有効化されていることを確認
# プロンプトに(venv)が表示されていることを確認
# 表示されていない場合は、以下を実行:
# Windows（コマンドプロンプト/PowerShell）: venv\Scripts\activate
# Windows（Git Bash、WSL、MSYS2などのbashシェル）: source venv/Scripts/activate
# Mac/Linux: source venv/bin/activate

# Windowsの場合（コマンドプロンプト/PowerShell）
py -c "import selenium; print('Selenium:', selenium.__version__)"
py -c "import pandas; print('Pandas:', pandas.__version__)"

# Windowsの場合（Git Bash、WSL、MSYS2などのbashシェル）
# ⚠️ 重要: bashシェルでは、仮想環境を有効化した後は`python`または`python3`コマンドを使用してください
# `py`コマンドは仮想環境内のPythonを指しません
python -c "import selenium; print('Selenium:', selenium.__version__)"
python -c "import pandas; print('Pandas:', pandas.__version__)"
# または
python3 -c "import selenium; print('Selenium:', selenium.__version__)"
python3 -c "import pandas; print('Pandas:', pandas.__version__)"

# Mac/Linuxの場合
python3 -c "import selenium; print('Selenium:', selenium.__version__)"
python3 -c "import pandas; print('Pandas:', pandas.__version__)"
```

**注意:** `ModuleNotFoundError`が発生する場合は、以下を確認してください:
1. 仮想環境が有効化されているか（プロンプトに`(venv)`が表示されているか）
2. `pip install -r requirements.txt`が正常に完了したか
3. 仮想環境内で実行しているか（グローバル環境ではなく）

---

## 環境変数の設定

### 1. .envファイルの作成

`inventory_scraper`ディレクトリ内に`.env`ファイルを作成します。

```bash
# Windowsの場合
copy .env.example .env

# Mac/Linuxの場合
cp .env.example .env
```

### 2. .envファイルの編集

`.env`ファイルをテキストエディタで開き、以下の値を設定します。

```ini
# スプレッドシート情報
SPREADSHEET_ID=xxxxxxxxxxxxxxxxxxx
SHEET_GID=0

# Google Apps Script WebアプリURL（必須）
GAS_WEB_APP_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec

# ローカルChrome設定
CHROME_PROFILE_PATH=C:\Users\Username\AppData\Local\Google\Chrome\User Data
CHROME_PROFILE_NAME=Default

# ダウンロードフォルダ（Windowsの場合）
DOWNLOAD_FOLDER=C:\Users\Username\Downloads

# ログ設定
LOG_LEVEL=INFO
```

### 3. 各設定値の取得方法

#### SPREADSHEET_ID（スプレッドシートID）

1. 対象のGoogleスプレッドシートを開く
2. URLを確認
   - 例: `https://docs.google.com/spreadsheets/d/1ABC123xyz789/edit`
   - `SPREADSHEET_ID`は`/d/`と`/edit`の間の文字列（`1ABC123xyz789`）

#### SHEET_GID（シートGID）

1. スプレッドシートで「在庫管理」シートを開く
2. URLを確認
   - 例: `https://docs.google.com/spreadsheets/d/1ABC123xyz789/edit#gid=0`
   - `SHEET_GID`は`gid=`の後の数字（`0`）
   - 通常は`0`ですが、シートの順序によって異なる場合があります

#### GAS_WEB_APP_URL（GAS WebアプリURL）

- GAS側でWebアプリとしてデプロイした際に取得できるURL
- 後述の「GAS側の設定」セクションで取得方法を説明します

**GAS WebアプリURLの例:**
```
GAS_WEB_APP_URL=https://script.google.com/macros/s/AKfycbz1234567890abcdef/exec
```

**注意:**
- Webアプリとしてデプロイする際は「全員（匿名ユーザーを含む）がアクセス可能」に設定してください
- デプロイ後、新しいバージョンを保存する必要があります

#### CHROME_PROFILE_PATH（Chromeプロファイルパス）

**Windowsの場合:**
```
C:\Users\[ユーザー名]\AppData\Local\Google\Chrome\User Data
```

**Macの場合:**
```
/Users/[ユーザー名]/Library/Application Support/Google/Chrome
```

**Linuxの場合:**
```
/home/[ユーザー名]/.config/google-chrome
```

**確認方法（推奨）:**

1. **Chromeを起動**
2. **アドレスバーに `chrome://version` と入力してEnterキーを押す**
3. **「プロファイルパス」の行を確認**
   - 例: `C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default`
4. **プロファイルパスから「\Default」または「\Profile 1」などのプロファイル名部分を除いたパスを`.env`ファイルの`CHROME_PROFILE_PATH`に設定**
   - 例: `C:\Users\Username\AppData\Local\Google\Chrome\User Data`
5. **プロファイル名部分を`.env`ファイルの`CHROME_PROFILE_NAME`に設定**
   - 例: `Default` または `Profile 1`

**注意:**
- `AppData`フォルダは隠しフォルダです。エクスプローラーで表示するには、「表示」タブ→「隠しファイル」にチェックを入れてください
- または、エクスプローラーのアドレスバーに直接パスを入力してアクセスできます
- `[ユーザー名]`の部分は、実際のWindowsユーザー名に置き換えてください
- Windowsユーザー名を確認するには、コマンドプロンプトで `echo %USERNAME%` を実行してください
- 複数のChromeプロファイルを使用している場合は、対象のプロファイル名を確認してください

#### CHROME_PROFILE_NAME（Chromeプロファイル名）

- 通常は`Default`
- 複数のプロファイルを使用している場合は、対象プロファイル名を指定
- 確認方法: Chromeの設定画面でプロファイル名を確認

#### DOWNLOAD_FOLDER（ダウンロードフォルダ）

**Windowsの場合:**
```
C:\Users\[ユーザー名]\Downloads
```

**Macの場合:**
```
/Users/[ユーザー名]/Downloads
```

**Linuxの場合:**
```
/home/[ユーザー名]/Downloads
```

---

## GAS側の設定

### 1. Apps Scriptエディタを開く

1. 対象のスプレッドシートを開く
2. 「拡張機能」→「Apps Script」をクリック

### 2. WebScrapingDirectUpdate.gsの確認

`src/WebScrapingDirectUpdate.gs`ファイルが既にプロジェクトに追加されていることを確認します。

### 3. GAS Webアプリとしてデプロイ

1. Apps Scriptエディタで「デプロイ」→「デプロイを管理」をクリック
2. 「新しいデプロイ」をクリック
3. 種類の選択で「ウェブアプリ」を選択
4. 以下の設定を入力:
   - **説明**: 任意（例: 「ウェブスクレイピング結果更新用」）
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員（匿名ユーザーを含む）
5. 「デプロイ」をクリック
6. 表示されたWebアプリURLをコピー
7. `.env`ファイルの`GAS_WEB_APP_URL`に設定

**GAS WebアプリURLの例:**
```
GAS_WEB_APP_URL=https://script.google.com/macros/s/AKfycbz1234567890abcdef/exec
```

**重要:** 
- コードを更新した場合は、「デプロイを管理」から既存のデプロイを選択し、「新しいバージョンを保存」をクリックする必要があります
- 新しいバージョンを保存しないと、変更が反映されません

### 4. 動作確認

1. Pythonスクリプトを実行してテスト
2. Apps Scriptエディタの「実行」ログを確認
3. エラーが発生していないことを確認

---

## Chromeプロファイルの設定

### 1. ChromeにGoogleアカウントでログイン

1. Chromeを起動
2. 右上のプロフィールアイコンをクリック
3. 「サインイン」を選択
4. スプレッドシートとフォームにアクセスできるGoogleアカウントでログイン

### 2. プロファイルパスの確認

**方法A: Chromeで確認（推奨）**

1. Chromeを起動
2. アドレスバーに `chrome://version` と入力してEnterキーを押す
3. 「プロファイルパス」の行を確認
4. プロファイルパスから「\Default」または「\Profile 1」などのプロファイル名部分を除いたパスを`.env`ファイルの`CHROME_PROFILE_PATH`に設定
5. プロファイル名部分を`.env`ファイルの`CHROME_PROFILE_NAME`に設定

**例（Windows）:**
```
プロファイルパス（chrome://versionで確認）: C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default
CHROME_PROFILE_PATH: C:\Users\Username\AppData\Local\Google\Chrome\User Data
CHROME_PROFILE_NAME: Default
```

**方法B: エクスプローラーで確認**

1. エクスプローラーを開く
2. 「表示」タブ→「隠しファイル」にチェックを入れる
3. アドレスバーに `%LOCALAPPDATA%\Google\Chrome\User Data` と入力してEnterキーを押す
4. または、`C:\Users\[ユーザー名]\AppData\Local\Google\Chrome\User Data` を直接入力
5. フォルダが存在することを確認し、パスをコピー

**注意:**
- `AppData`フォルダは隠しフォルダです。エクスプローラーで表示するには、「表示」タブ→「隠しファイル」にチェックを入れてください
- `[ユーザー名]`の部分は、実際のWindowsユーザー名に置き換えてください
- Windowsユーザー名を確認するには、コマンドプロンプトで `echo %USERNAME%` を実行してください

### 3. スプレッドシートへのアクセス確認

1. Chromeでスプレッドシートを開く
2. 正常に表示されることを確認
3. 編集権限があることを確認

---

## 動作確認手順

**重要:** 以下のすべての動作確認手順は、**仮想環境を有効化した状態で実行してください。**
仮想環境が有効化されていない場合は、先に以下を実行してください:

```bash
# Windowsの場合（コマンドプロンプトまたはPowerShell）
venv\Scripts\activate

# Windowsの場合（Git Bash、WSL、MSYS2などのbashシェル）
source venv/Scripts/activate

# Mac/Linuxの場合
source venv/bin/activate
```

### 1. 設定の確認

以下のコマンドで設定を確認します（Pythonスクリプトを作成して実行）。

```python
# test_config.py
from src.config import (
    SPREADSHEET_ID, SHEET_GID, GAS_WEB_APP_URL,
    CHROME_PROFILE_PATH, CHROME_PROFILE_NAME
)

print("=== 設定確認 ===")
print(f"SPREADSHEET_ID: {SPREADSHEET_ID}")
print(f"SHEET_GID: {SHEET_GID}")
print(f"GAS_WEB_APP_URL: {GAS_WEB_APP_URL}")
print(f"CHROME_PROFILE_PATH: {CHROME_PROFILE_PATH}")
print(f"CHROME_PROFILE_NAME: {CHROME_PROFILE_NAME}")
```

実行:
```bash
# 仮想環境を有効化した状態で実行
# Windows（コマンドプロンプト/PowerShell）の場合
py test_config.py

# Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
# ⚠️ 重要: bashシェルでは`python`または`python3`コマンドを使用してください
python test_config.py
# または
python3 test_config.py

# Mac/Linuxの場合
python3 test_config.py
```

### 2. ブラウザの起動テスト

```python
# test_browser.py
from src.browser import create_browser

print("ブラウザを起動しています...")
browser = create_browser()
print("ブラウザが正常に起動しました")
browser.get("https://www.google.com")
print("Googleにアクセスしました")
browser.quit()
print("ブラウザを閉じました")
```

実行:
```bash
# 仮想環境を有効化した状態で実行
# Windows（コマンドプロンプト/PowerShell）の場合
py test_browser.py

# Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
# ⚠️ 重要: bashシェルでは`python`または`python3`コマンドを使用してください
python test_browser.py
# または
python3 test_browser.py

# Mac/Linuxの場合
python3 test_browser.py
```

### 3. スプレッドシートダウンロードテスト

```python
# test_download.py
from src.browser import create_browser
from src.downloader import download_spreadsheet_csv

print("ブラウザを起動しています...")
browser = create_browser()

try:
    print("スプレッドシートからCSVをダウンロードしています...")
    df = download_spreadsheet_csv(browser)
    print(f"ダウンロード成功: {len(df)}行のデータを取得しました")
    print(df.head())
finally:
    browser.quit()
```

実行:
```bash
# 仮想環境を有効化した状態で実行
# Windows（コマンドプロンプト/PowerShell）の場合
py test_download.py

# Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
# ⚠️ 重要: bashシェルでは`python`または`python3`コマンドを使用してください
python test_download.py
# または
python3 test_download.py

# Mac/Linuxの場合
python3 test_download.py
```

### 4. 全体動作テスト

```bash
# 仮想環境を有効化した状態で実行
# Windows（コマンドプロンプト/PowerShell）の場合
py main.py

# Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
# ⚠️ 重要: bashシェルでは`python`または`python3`コマンドを使用してください
python main.py
# または
python3 main.py

# Mac/Linuxの場合
python3 main.py
```

実行後、以下を確認:
1. スプレッドシートが正常にダウンロードされたか
2. スクレイピングが正常に実行されたか
3. CSVファイルが正常に生成されたか
4. GAS WebアプリへのPOST送信が成功したか
5. スプレッドシートが正常に更新されたか

---

## トラブルシューティング

### ChromeDriverのエラー

**エラー:** `selenium.common.exceptions.WebDriverException: Message: 'chromedriver' executable needs to be in PATH`

**解決方法:**
1. `webdriver-manager`が自動的にChromeDriverをダウンロードしますが、エラーが発生する場合は手動でインストール
2. Chromeのバージョンを確認: `chrome://version`
3. 対応するChromeDriverをダウンロード: https://chromedriver.chromium.org/
4. 環境変数PATHに追加するか、プロジェクトディレクトリに配置

### CSVダウンロードがタイムアウトする

**原因:**
- ダウンロードフォルダのパスが正しく設定されていない
- ネットワーク接続の問題

**解決方法:**
1. `.env`の`DOWNLOAD_FOLDER`が正しく設定されているか確認
2. `inventory_scraper/data`ディレクトリが存在するか確認
3. スプレッドシートのURLが正しいか確認
4. スプレッドシートへのアクセス権限があるか確認

### GAS Webアプリ更新が失敗する

**原因:**
- `GAS_WEB_APP_URL`が正しく設定されていない
- GAS側で`doPost`関数が正しくデプロイされていない
- ネットワーク接続の問題

**解決方法:**

1. **GAS_WEB_APP_URLの確認**
   - `.env`ファイルの`GAS_WEB_APP_URL`が正しく設定されているか確認
   - URLは`https://script.google.com/macros/s/.../exec`の形式であることを確認

2. **GAS側のデプロイ確認**
   - Apps Scriptエディタで「デプロイ」→「デプロイを管理」を開く
   - 既存のデプロイを選択して「新しいバージョンを保存」をクリック
   - コードを更新した場合は、必ず新しいバージョンを保存する必要があります

3. **GAS側のログ確認**
   - Apps Scriptエディタの「実行」ログを確認
   - エラーが発生している場合は、エラーメッセージを確認

4. **ネットワーク接続の確認**
   - インターネット接続が正常であることを確認
   - ファイアウォールやプロキシの設定を確認

### GAS Webアプリがエラーを返す

**原因:**
- トリガーが正しく設定されていない
- 権限の問題

**解決方法:**
1. Apps Scriptエディタでトリガーが設定されているか確認
2. トリガーの実行ログを確認
3. 権限の承認が必要な場合は再承認

### FormApp.create の権限エラー

**エラー:** `指定された権限では FormApp.create を呼び出すことができません。必要な権限: https://www.googleapis.com/auth/forms`

**原因:**
- `appsscript.json`にForms APIのスコープが設定されていない

**解決方法:**
1. Apps Scriptエディタで`appsscript.json`ファイルを開く
2. `oauthScopes`配列に`https://www.googleapis.com/auth/forms`を追加
3. ファイルを保存
4. 再度フォーム作成機能を実行し、権限の承認を行う
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「[プロジェクト名]（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

### スクレイピングが失敗する

**原因:**
- ECサイトのHTML構造が変更された
- Bot検知された

**解決方法:**
1. `src/scraper.py`のセレクタを確認・調整
2. 待機時間を長くする
3. User-Agentを変更する

### Chromeプロファイルが見つからない

**原因:**
- プロファイルパスが正しく設定されていない
- Chromeが起動中でプロファイルがロックされている
- `AppData`フォルダが隠しフォルダで表示されていない
- ユーザー名が正しく設定されていない

**解決方法:**

1. **Chromeでプロファイルパスを確認（最も確実な方法）**
   - Chromeを起動
   - アドレスバーに `chrome://version` と入力してEnterキーを押す
   - 「プロファイルパス」の行をコピー
   - 例: `C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default`
   - このパスから「\Default」または「\Profile 1」などのプロファイル名部分を除いたパスを`.env`の`CHROME_PROFILE_PATH`に設定
   - プロファイル名部分を`.env`の`CHROME_PROFILE_NAME`に設定

2. **エクスプローラーでパスを確認**
   - エクスプローラーを開く
   - 「表示」タブ→「隠しファイル」にチェックを入れる
   - アドレスバーに `%LOCALAPPDATA%\Google\Chrome\User Data` と入力してEnterキーを押す
   - または、`C:\Users\[ユーザー名]\AppData\Local\Google\Chrome\User Data` を直接入力
   - フォルダが存在することを確認

3. **Windowsユーザー名を確認**
   - コマンドプロンプトまたはPowerShellを開く
   - `echo %USERNAME%` を実行（コマンドプロンプトの場合）
   - または `$env:USERNAME` を実行（PowerShellの場合）
   - 表示されたユーザー名でパスを確認

4. **Chromeを完全に終了**
   - タスクマネージャーを開く（Ctrl+Shift+Esc）
   - 「Google Chrome」のプロセスをすべて終了
   - 再実行

5. **代替パスの確認**
   - Chromeのインストール方法によっては、プロファイルパスが異なる場合があります
   - 以下のパスも確認してください:
     - `C:\Users\[ユーザー名]\AppData\Local\Google\Chrome\User Data`
     - `C:\Program Files\Google\Chrome\User Data`（管理者権限でインストールした場合）
     - `C:\Program Files (x86)\Google\Chrome\User Data`（32bit版の場合）

6. **環境変数を使用したパス指定**
   - `.env`ファイルで環境変数を使用することもできます:
     ```
     CHROME_PROFILE_PATH=%LOCALAPPDATA%\Google\Chrome\User Data
     ```
   - ただし、Pythonの`python-dotenv`が環境変数を展開しない場合は、絶対パスを使用してください

### ログファイルが見つからない

**原因:**
- `logs`ディレクトリが作成されていない

**解決方法:**
1. `inventory_scraper/logs`ディレクトリが存在するか確認
2. 存在しない場合は手動で作成

### bashシェルで`source venv\Scripts\activate`を実行するとエラーになる

**エラー:** `source venv\Scripts\activate`を実行すると`bash: venvScriptsactivate: No such file or directory`が発生する

**原因:**
- bashシェル（Git Bash、WSL、MSYS2など）でバックスラッシュ`\`を使用している
- bashではバックスラッシュ`\`がエスケープ文字として扱われるため、`venv\Scripts\activate`は`venvScriptsactivate`として解釈される

**解決方法:**

```bash
# ❌ 間違い（bashシェルでは動作しません）
source venv\Scripts\activate

# ✅ 正しい（bashシェルではスラッシュ`/`を使用）
source venv/Scripts/activate
```

**確認方法:**
```bash
# シェルの種類を確認
echo $SHELL
# または
ps -p $$

# bashシェルの場合、プロンプトは以下のような形式です:
# $ または username@hostname:~$
```

**注意:**
- コマンドプロンプトまたはPowerShellを使用している場合は、`venv\Scripts\activate`（バックスラッシュ`\`）を使用します
- bashシェル（Git Bash、WSL、MSYS2など）を使用している場合は、`source venv/Scripts/activate`（スラッシュ`/`）を使用します

### bashシェルで`py`コマンドを使用すると`ModuleNotFoundError`が発生する

**エラー:** bashシェル（Git Bash、WSL、MSYS2など）で仮想環境を有効化した後、`py -c "import pandas; print('Pandas:', pandas.__version__)"`を実行すると`ModuleNotFoundError: No module named 'pandas'`が発生する

**原因:**
- bashシェルでは、`py`コマンドはWindowsのPython Launcherを指しており、仮想環境内のPythonを指していません
- 仮想環境を有効化しても、`py`コマンドは仮想環境のPATH変更の影響を受けません

**解決方法:**

```bash
# ❌ 間違い（bashシェルでは動作しません）
py -c "import pandas; print('Pandas:', pandas.__version__)"

# ✅ 正しい（bashシェルでは`python`または`python3`コマンドを使用）
python -c "import pandas; print('Pandas:', pandas.__version__)"
# または
python3 -c "import pandas; print('Pandas:', pandas.__version__)"
```

**確認方法:**
```bash
# 仮想環境が有効化されていることを確認（プロンプトに(venv)が表示されている）
# 使用しているPythonのパスを確認
which python
which python3

# 仮想環境内のPythonを指していることを確認
# 出力例: /n/development/Sales-Management-Spreadsheet/inventory_scraper/venv/Scripts/python
```

**注意:**
- コマンドプロンプトまたはPowerShellを使用している場合は、`py`コマンドを使用できます
- bashシェル（Git Bash、WSL、MSYS2など）を使用している場合は、**必ず`python`または`python3`コマンドを使用してください**

### `ModuleNotFoundError: No module named 'pandas'`などのエラーが発生する

**エラー:** `py -c "import pandas; print('Pandas:', pandas.__version__)"`または`python -c "import pandas; print('Pandas:', pandas.__version__)"`を実行すると`ModuleNotFoundError: No module named 'pandas'`が発生する

**原因:**
- 仮想環境が有効化されていない
- 依存パッケージがインストールされていない
- グローバル環境で実行している（仮想環境外で実行している）
- **bashシェルで`py`コマンドを使用している**（`py`コマンドは仮想環境内のPythonを指しません）

**解決方法:**

1. **仮想環境が有効化されているか確認**
   ```bash
   # プロンプトに(venv)が表示されているか確認
   # 表示されていない場合は、以下を実行:
   # Windows（コマンドプロンプト/PowerShell）の場合
   venv\Scripts\activate
   
   # Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
   source venv/Scripts/activate
   
   # Mac/Linuxの場合
   source venv/bin/activate
   ```

2. **依存パッケージがインストールされているか確認**
   ```bash
   # 仮想環境を有効化した状態で実行
   # インストールされているパッケージの一覧を確認
   pip list
   
   # pandasがインストールされているか確認
   pip show pandas
   
   # もしpandasが表示されない場合は、依存パッケージをインストールする必要があります
   ```

3. **依存パッケージをインストール**
   ```bash
   # 仮想環境を有効化した状態で実行
   # プロジェクトディレクトリ（inventory_scraper）にいることを確認
   cd inventory_scraper
   
   # requirements.txtが存在するか確認
   ls requirements.txt  # Mac/Linux/bashの場合
   dir requirements.txt  # Windowsコマンドプロンプトの場合
   
   # 依存パッケージをインストール
   pip install -r requirements.txt
   
   # インストールが正常に完了したか確認
   pip list
   ```

4. **インストール確認**
   ```bash
   # 仮想環境を有効化した状態で実行
   # Windows（コマンドプロンプト/PowerShell）の場合
   py -c "import pandas; print('Pandas:', pandas.__version__)"
   py -c "import selenium; print('Selenium:', selenium.__version__)"
   
   # Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
   # ⚠️ 重要: bashシェルでは`python`または`python3`コマンドを使用してください
   # `py`コマンドは仮想環境内のPythonを指しません
   python -c "import pandas; print('Pandas:', pandas.__version__)"
   python -c "import selenium; print('Selenium:', selenium.__version__)"
   # または
   python3 -c "import pandas; print('Pandas:', pandas.__version__)"
   python3 -c "import selenium; print('Selenium:', selenium.__version__)"
   
   # Mac/Linuxの場合
   python3 -c "import pandas; print('Pandas:', pandas.__version__)"
   python3 -c "import selenium; print('Selenium:', selenium.__version__)"
   ```

5. **仮想環境内のpipを使用しているか確認**
   ```bash
   # 仮想環境を有効化した状態で実行
   # pipのパスを確認（仮想環境内のpipを指しているか確認）
   where pip  # Windowsの場合
   which pip  # Mac/Linuxの場合
   
   # 出力例（Windows）:
   # N:\development\Sales-Management-Spreadsheet\inventory_scraper\venv\Scripts\pip.exe
   ```

6. **仮想環境を再作成する（最終手段）**
   ```bash
   # 仮想環境を削除
   # Windowsの場合
   rmdir /s venv
   
   # Mac/Linuxの場合
   rm -rf venv
   
   # 仮想環境を再作成
   py -m venv venv  # Windowsの場合
   python3 -m venv venv  # Mac/Linuxの場合
   
   # 仮想環境を有効化
   venv\Scripts\activate  # Windows（コマンドプロンプト/PowerShell）の場合
   source venv/Scripts/activate  # Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
   source venv/bin/activate  # Mac/Linuxの場合
   
   # 依存パッケージを再インストール
   pip install -r requirements.txt
   ```

**確認方法:**
```bash
# 1. 仮想環境が有効化されているか確認
# プロンプトに(venv)が表示されていることを確認

# 2. 使用しているPythonのパスを確認（仮想環境内のPythonを指しているか確認）
which python  # Mac/Linux/bashの場合
where python  # Windowsコマンドプロンプトの場合

# 出力例（bash）: /n/development/Sales-Management-Spreadsheet/inventory_scraper/venv/Scripts/python
# 出力例（Windows）: N:\development\Sales-Management-Spreadsheet\inventory_scraper\venv\Scripts\python.exe

# 3. 使用しているpipのパスを確認（仮想環境内のpipを指しているか確認）
which pip  # Mac/Linux/bashの場合
where pip  # Windowsコマンドプロンプトの場合

# 出力例（bash）: /n/development/Sales-Management-Spreadsheet/inventory_scraper/venv/Scripts/pip
# 出力例（Windows）: N:\development\Sales-Management-Spreadsheet\inventory_scraper\venv\Scripts\pip.exe

# 4. インストールされているパッケージを確認
pip list

# 5. 特定のパッケージがインストールされているか確認
pip show pandas
pip show selenium

# 6. requirements.txtの内容を確認
cat requirements.txt  # Mac/Linux/bashの場合
type requirements.txt  # Windowsコマンドプロンプトの場合
```

### `python`または`python3`コマンド実行時に「Python」とだけ表示される

**エラー:** `python -m venv venv`または`python3 -m venv venv`を実行すると「Python」というテキストだけが表示され、仮想環境が作成されない

**原因:**
- WindowsストアのPythonランチャーが`python`および`python3`コマンドを指している
- Windows 10/11でMicrosoft StoreからPythonをインストールした場合に発生しやすい
- このランチャーは実際のPythonインタープリタではなく、ストアアプリへのリダイレクトのみを行う
- **`python3`コマンドでも同様の問題が発生する場合があります**

**解決方法（優先順位順）:**

1. **`py`コマンドを使用する（最推奨・最も確実）**
   ```bash
   py -m venv venv
   # Windows（コマンドプロンプト/PowerShell）の場合
   venv\Scripts\activate
   # Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
   source venv/Scripts/activate
   ```
   `py`コマンドは「Python Launcher for Windows」で、インストールされているPythonを自動的に検出して実行します。**この方法が最も確実です。**

2. **Pythonのフルパスを指定する**
   ```bash
   # まず、Pythonのインストールパスを確認
   # 方法A: pyコマンドで確認
   py -c "import sys; print(sys.executable)"
   
   # 方法B: 一般的なインストールパスを確認
   # C:\Python310\python.exe
   # C:\Python311\python.exe
   # C:\Users\[ユーザー名]\AppData\Local\Programs\Python\Python310\python.exe
   # C:\Program Files\Python310\python.exe
   
   # 確認したパスを使用
   C:\Python310\python.exe -m venv venv
   # Windows（コマンドプロンプト/PowerShell）の場合
   venv\Scripts\activate
   # Windows（Git Bash、WSL、MSYS2などのbashシェル）の場合
   source venv/Scripts/activate
   ```

3. **WindowsストアのPythonランチャーを無効化する（上級者向け）**
   - Windowsの設定 → アプリ → アプリの実行エイリアス
   - 「アプリのインストーラー」セクションで「python.exe」と「python3.exe」のトグルを**オフ**にする
   - 注意: この設定を変更すると、他のアプリケーションに影響する可能性があります
   - 無効化後、`python`または`python3`コマンドが正常に動作するか確認

4. **Pythonの再インストール（最終手段）**
   - https://www.python.org/downloads/ から公式インストーラーをダウンロード
   - インストール時に「Add Python to PATH」にチェックを入れる
   - Microsoft Store版ではなく、公式版をインストールする
   - インストール後、コマンドプロンプトを再起動してから確認

**確認方法:**
```bash
# どのPythonが実行されるか確認（Windowsストアのランチャーを指している可能性あり）
where python
where python3

# pyコマンドのパスを確認（通常は正常に動作）
where py

# Pythonのバージョンを確認（pyコマンドが推奨）
py --version

# Pythonのインストールパスを確認
py -c "import sys; print(sys.executable)"

# 複数のPythonがインストールされている場合、バージョンを指定
py -3.10 -m venv venv
py -3.11 -m venv venv
```

**注意:** `python`や`python3`コマンドで「Python」とだけ表示される場合は、**必ず`py`コマンドを使用してください。** `py`コマンドはWindowsに標準で含まれており、インストールされているPythonを自動的に検出します。

---

## よくある質問（FAQ）

### Q1: 複数のスプレッドシートを処理できますか？

A: 現在の実装では1つのスプレッドシートのみ対応しています。複数のスプレッドシートを処理する場合は、`.env`ファイルを切り替えるか、設定を変更してください。

### Q2: スクレイピングの頻度はどのくらいが適切ですか？

A: ECサイトへの負荷を考慮して、1日1回程度の実行を推奨します。タスクスケジューラで自動実行する場合は、適切な間隔を設定してください。

### Q3: エラーが発生した場合のログはどこに保存されますか？

A: `inventory_scraper/logs/`ディレクトリに`scraper_YYYYMMDD_HHMMSS.log`形式で保存されます。

### Q4: Chromeプロファイルを複数使用できますか？

A: はい、`.env`の`CHROME_PROFILE_NAME`を変更することで、異なるプロファイルを使用できます。

### Q5: スクレイピング対象のECサイトを追加できますか？

A: はい、`src/scraper.py`に新しいスクレイパークラスを追加し、`get_scraper`関数で判定ロジックを追加してください。

---

## サポート

問題が解決しない場合は、以下を確認してください:

1. ログファイル（`logs/scraper_*.log`）の内容
2. Apps Scriptの実行ログ
3. Chromeのコンソールエラー（開発者ツールで確認）

---

**最終更新日:** 2025-12-15
