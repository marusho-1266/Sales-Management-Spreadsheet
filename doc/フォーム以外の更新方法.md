# フォーム以外のスプレッドシート更新方法

## 概要

現在の実装では、Googleフォーム経由でスプレッドシートに反映させようとしていますが、うまく動作しない場合があります。
このドキュメントでは、フォーム以外の方法でスプレッドシートに反映させる方法を説明します。

## 方法1: Google Apps ScriptのWebアプリ経由（推奨）

### 概要

Google Apps Scriptの関数をWebアプリとして公開し、Pythonから直接呼び出す方法です。
フォーム経由よりも確実で、エラーハンドリングも容易です。

### 制約について

**注意**: この方法は設計書の「GASウェブアプリ化不可」の制約に反する可能性があります。
ただし、より確実な方法として提供します。設計書の制約を緩和する必要がある場合は、
プロジェクト管理者に相談してください。

### セットアップ手順

#### 1. Google Apps ScriptのWebアプリとして公開

1. Googleスプレッドシートを開く
2. 「拡張機能」→「Apps Script」を開く
3. `src/WebScrapingDirectUpdate.gs`の内容をコピーして、新しいファイルとして追加
4. 「デプロイ」→「新しいデプロイ」をクリック
5. 種類の選択で「ウェブアプリ」を選択
6. 以下の設定を行う：
   - **説明**: 在庫管理スクレイピング結果更新
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員（または特定のユーザー）
7. 「デプロイ」をクリック
8. 表示されたWebアプリURLをコピー

#### 2. 環境変数の設定

`.env`ファイルに以下を追加：

```ini
# Google Apps Script WebアプリURL（直接更新用）
GAS_WEB_APP_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

#### 3. Python側の設定

`inventory_scraper/main.py`で、`use_direct_update = True`に設定します（デフォルトでTrueになっています）。

### 使用方法

```bash
python main.py
```

Pythonスクリプトが自動的にGoogle Apps ScriptのWebアプリを呼び出し、スプレッドシートを更新します。

### メリット

- ✅ フォーム経由よりも確実
- ✅ エラーハンドリングが容易
- ✅ レスポンスを確認できる
- ✅ デバッグが容易

### デメリット

- ⚠️ 設計書の「GASウェブアプリ化不可」の制約に反する可能性がある
- ⚠️ Webアプリとして公開する必要がある（セキュリティ設定が必要）

---

## 方法2: Google Drive APIを使用（制約に反する）

### 概要

Google Drive APIを使用して、スプレッドシートを直接更新する方法です。

### 制約について

**注意**: この方法は設計書の「GCP利用不可」の制約に反します。
サービスアカウントキーの発行が必要なため、この方法は使用できません。

---

## 方法3: Seleniumでスプレッドシートを直接編集（技術的に困難）

### 概要

Seleniumを使用して、ブラウザでスプレッドシートを開き、セルを直接編集する方法です。

### 制約について

この方法は設計書の制約に反しませんが、技術的に非常に困難です。
GoogleスプレッドシートのUIは複雑で、セルを直接編集するのは実用的ではありません。

### 実装状況

`inventory_scraper/src/spreadsheet_updater.py`に実装を試みましたが、
実際には動作しない可能性が高いです。

---

## 推奨される対応

### 1. フォーム経由の方法を改善する

まず、フォーム経由の方法がうまく動作しない原因を調査し、改善することを推奨します。

**確認事項**:
- フォームにファイルアップロード項目が正しく追加されているか
- トリガーが正しく設定されているか
- GASのログにエラーが記録されていないか

### 2. 設計書の制約を緩和する

フォーム経由の方法が改善できない場合、設計書の制約を緩和し、
Google Apps ScriptのWebアプリ経由の方法を使用することを推奨します。

**緩和が必要な制約**:
- 「GASウェブアプリ化不可」→「GASウェブアプリ化可（セキュリティ設定必須）」

### 3. 一時的な回避策

一時的な回避策として、以下の方法があります：

1. **手動でのCSVインポート**: CSVファイルを手動でGoogleスプレッドシートにインポート
2. **Google Apps Scriptの手動実行**: `testUpdateFromCsv()`関数を手動で実行

---

## 実装ファイル

- `src/WebScrapingDirectUpdate.gs`: Google Apps Scriptの直接更新関数
- `inventory_scraper/src/spreadsheet_updater.py`: Python側の更新モジュール
- `inventory_scraper/main.py`: メイン処理（直接更新とフォーム経由の切り替え）

---

## トラブルシューティング

### Google Apps ScriptのWebアプリが動作しない場合

1. **権限エラー**: Webアプリのアクセス権限を確認
2. **URLエラー**: WebアプリURLが正しいか確認
3. **CSVデータサイズ**: URLパラメータのサイズ制限（約2000文字）を超えていないか確認

### フォーム経由の方法が動作しない場合

1. **トリガー設定**: フォーム送信時トリガーが正しく設定されているか確認
2. **ファイルアップロード項目**: フォームにファイルアップロード項目が追加されているか確認
3. **GASログ**: Apps Scriptエディタの実行ログを確認

---

**作成日**: 2025-12-24  
**最終更新**: 2025-12-24

