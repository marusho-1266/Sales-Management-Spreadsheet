# 在庫管理ツール システム仕様書

## 1. システム概要

### 1.1 目的
ECサイト運営における在庫管理、売上管理、利益計算、価格変動通知を効率化するためのGoogleスプレッドシートベースの管理システム

### 1.2 対象ユーザー
- ECサイト運営者
- 複数スタッフでの利用を想定

### 1.3 技術スタック
- **基盤**: Googleスプレッドシート
- **自動化**: Google Apps Script (GAS)
- **データ取得**: スクレイピング（ルールベース）
- **将来拡張**: Amazon SP-API対応予定

## 2. 機能要件

### 2.1 在庫管理機能

#### 2.1.1 仕入れ元管理
- **機能**: 仕入れ先サイトのURL登録・管理
- **対象サイト**:
  - メルカリ
  - ヤフーフリマ
  - ヤフオク
  - 楽天
  - Yahooショッピング
  - Amazon
  - 個人ショップ（手動追加可能）
- **実装方法**: マスターテーブルによる管理

#### 2.1.2 在庫判定機能
- **判定方法**: 仕入れ先サイトの特定文字列検出
  - 購入可能: 「購入手続きへ」「カートに入れる」等
  - 売り切れ: 「売り切れ」「SOLD OUT」等
- **判定ルール**: シート上で管理、後から追加・変更可能
- **Amazon対応**: ASINコードによる在庫確認
- **制約**: サイト仕様変更による判定精度の変動リスク

#### 2.1.3 価格・利益管理
- **仕入れ価格**: 各サイトからの価格取得
- **販売価格**: 手動設定
- **為替計算**: GOOGLEFINANCE関数によるドル円換算
- **利益計算**: 自動計算（販売価格 - 仕入れ価格 - 手数料）

### 2.2 売上管理機能

#### 2.2.1 注文データ管理
- **データ入力**: Joom注文データの登録
- **紐付け**: SKU/ASINによる在庫管理表との連携
- **在庫減算**: 売上発生時の自動在庫数更新

#### 2.2.2 利益計算
- **手数料計算**: 各ECサイトの手数料体系に基づく計算
- **純利益**: 手数料差し引き後の利益算出

### 2.3 CSV出力機能

#### 2.3.1 Joom形式CSV出力
- **出力対象**: 在庫管理表の商品データ
- **出力方法**: GASによるボタン操作での自動生成
- **形式**: Joomアップロード用CSVフォーマット
- **連携管理**: 未連携商品の識別と連携ステータス管理

#### 2.3.2 未連携商品管理
- **連携ステータス**: 未連携 / 連携済みの2段階管理
- **出力対象選択**: 全商品 / 未連携商品のみ / 選択商品
- **フィルタ機能**: 在庫あり、価格範囲等の条件指定
- **バリデーション**: 必須項目の入力チェックとエラーレポート

#### 2.3.3 データマッピング
- **必須フィールド**: SKU、商品名、商品説明、メイン画像URL、ストアID、重量、価格、通貨、在庫数量、配送価格
- **推奨フィールド**: ブランド、検索タグ、危険物種類、カテゴリID
- **自動変換**: 重量（g→kg）、価格（円→指定通貨）

### 2.4 価格変動通知機能

#### 2.4.1 視覚的通知
- **実装方法**: 条件付き書式によるセル色分け
- **対象**: 仕入れ価格、販売価格の変動
- **データ保持**: 前回価格の補助セル・シート

#### 2.4.2 メール通知
- **実装方法**: GASトリガー機能
- **実行頻度**: 定期実行（例：1日1回）
- **通知内容**: 商品名、変更前後の価格

## 3. 非機能要件

### 3.1 パフォーマンス
- **データ量**: 商品点数・月間注文データの想定量に応じた最適化
- **応答性**: スプレッドシートの動作速度維持

### 3.2 可用性
- **同時利用**: 複数ユーザーでの同時編集対応
- **データ整合性**: 同時編集時の競合回避

### 3.3 拡張性
- **API連携**: Amazon SP-API対応時の移行容易性
- **サイト追加**: 新規仕入れ先サイトの柔軟な追加

## 4. データ構造設計

### 4.1 シート構成

#### 4.1.1 在庫管理シート
| 項目 | データ型 | 説明 |
|------|----------|------|
| 商品ID | 数値 | 一意識別子（自然数1から順に付番） |
| 商品名 | 文字列 | 商品名称 |
| SKU | 文字列 | 商品管理コード |
| ASIN | 文字列 | Amazon商品コード |
| 仕入れ元 | 文字列 | 仕入れ先サイト名 |
| 仕入れ元URL | 文字列 | 商品ページURL |
| 仕入れ価格 | 数値 | 仕入れ価格（円） |
| 販売価格 | 数値 | 販売価格（円） |
| 重量 | 数値 | 商品重量（g） |
| 商品説明 | 文字列 | Joom用商品説明文 |
| メイン画像URL | 文字列 | Joom用メイン画像URL |
| 通貨 | 文字列 | 価格の通貨単位（デフォルト：JPY） |
| 配送価格 | 数値 | 配送価格（円） |
| 在庫数量 | 数値 | 在庫数量（個数） |
| 在庫ステータス | 文字列 | 在庫あり/売り切れ（仕入元サイトの在庫状況） |
| 利益 | 数値 | 自動計算値 |
| 最終更新日時 | 日時 | データ更新日時 |
| 備考・メモ | 文字列 | 備考・メモ |
| Joom連携ステータス | 文字列 | 未連携/連携済み |
| 最終出力日時 | 日時 | Joom CSV最終出力日時 |

#### 4.1.2 売上管理シート
| 項目 | データ型 | 説明 |
|------|----------|------|
| 注文ID | 数値 | 一意識別子（自然数1から順に付番） |
| 注文日 | 日付 | 注文受付日 |
| 商品ID | 数値 | 在庫管理シートとの紐付け |
| 商品名 | 文字列 | 商品名称 |
| SKU | 文字列 | 商品管理コード |
| ASIN | 文字列 | Amazon商品コード |
| 数量 | 数値 | 注文数量 |
| 販売価格 | 数値 | 実際の販売価格 |
| 仕入れ価格 | 数値 | 仕入れ価格（円） |
| 送料 | 数値 | Joom側で計算されるのでシステムでの計算不要 |
| 手数料 | 数値 | ECサイト手数料 |
| 純利益 | 数値 | 手数料差し引き後利益 |
| 登録日時 | 日時 | データ登録日時 |

#### 4.1.3 仕入れ元マスターシート
| 項目 | データ型 | 説明 |
|------|----------|------|
| サイト名 | 文字列 | 仕入れ先サイト名 |
| サイトURL | 文字列 | ベースURL |
| 在庫あり判定文字列 | 文字列 | 在庫あり時の検出文字列 |
| 売り切れ判定文字列 | 文字列 | 売り切れ時の検出文字列 |
| 価格取得セレクタ | 文字列 | 価格表示要素のセレクタ |

#### 4.1.4 価格履歴シート
| 項目 | データ型 | 説明 |
|------|----------|------|
| 商品ID | 数値 | 商品識別子（在庫管理シートの商品IDと連携） |
| チェック日時 | 日時 | 価格チェック実行日時 |
| 仕入れ価格 | 数値 | チェック時点の仕入れ価格 |
| 販売価格 | 数値 | チェック時点の販売価格 |
| 変動フラグ | 文字列 | 価格変動の有無 |

## 5. 技術的制約・リスク

### 5.1 スクレイピング制約
- **Amazon**: 規約によりスクレイピング制限、アクセスブロックリスク
- **サイト仕様変更**: 判定ルールの変更による機能停止リスク
- **アクセス頻度**: 過度なアクセスによるIP制限リスク

### 5.2 GAS制約
- **実行時間制限**: 6分/実行の制限
- **API呼び出し制限**: 1日あたりの制限
- **メール送信制限**: 1日あたりの送信数制限

### 5.3 スプレッドシート制約
- **セル数制限**: 500万セル
- **同時編集**: 複数ユーザー同時編集時の競合
- **計算負荷**: 大量データ処理時の動作速度低下

## 6. 運用要件

### 6.1 ユーザー権限
- **管理者**: 全機能利用可能
- **一般ユーザー**: データ閲覧・一部編集権限

### 6.2 バックアップ
- **自動バックアップ**: Googleドライブの自動保存機能
- **手動バックアップ**: 定期的なエクスポート

### 6.3 マニュアル
- **操作マニュアル**: スタッフ向け操作手順書
- **トラブルシューティング**: よくある問題と解決方法

### 6.4 ユーザーインターフェース

#### 6.4.1 カスタムメニュー構成
Googleスプレッドシートのカスタムメニューによる操作インターフェースを提供します。

```
📊 EC管理システム
├── 📦 商品管理
│   ├── 新商品追加
│   └── 商品削除
├── 📈 売上管理
│   └── 注文データ入力
├── 🔄 在庫チェック
│   ├── 全商品在庫チェック
│   ├── 選択商品チェック
│   └── 定期チェック設定
├── 📤 データ出力
│   └── Joom用CSV出力
└── ⚙️ システム設定
    └── 通知設定
```

#### 6.4.2 メニュー機能詳細

**📦 商品管理**
- **新商品追加**: 入力ウィンドウによる商品情報入力
- **商品削除**: 選択した商品の削除機能

**📈 売上管理**
- **注文データ入力**: 入力ウィンドウによるJoom注文データの入力

**🔄 在庫チェック**
- **全商品在庫チェック**: 全商品の一括在庫確認
- **選択商品チェック**: 選択した商品のみの在庫確認
- **定期チェック設定**: 自動在庫チェックのスケジュール設定

**📤 データ出力**
- **Joom用CSV出力**: 在庫データからJoom形式CSVの生成・ダウンロード
  - 未連携商品のみ出力
  - 全商品出力
  - 選択商品出力
  - 出力設定
- **連携ステータス更新**: Joom連携ステータスの一括更新

**⚙️ システム設定**
- **通知設定**: 価格変動通知の設定（メールアドレス、通知条件等）

#### 6.4.3 入力インターフェース
- **入力ウィンドウ（Phase 1）**: 基本的な入力機能
  - シンプルなpromptによる入力
  - 迅速な実装とデバッグ
  - 基本的なバリデーション機能
- **HTMLフォーム（Phase 2以降）**: 高度な入力機能
  - カスタムHTMLフォームによる入力
  - 高度なバリデーション機能
  - エラーハンドリング機能

#### 6.4.4 権限管理
- **管理者**: 全機能利用可能
- **一般ユーザー**: データ閲覧・一部編集権限

## 7. 将来拡張計画

### 7.1 短期拡張（3-6ヶ月）
- **API連携**: Amazon SP-API導入
- **通知機能強化**: Slack連携、LINE通知
- **レポート機能**: 売上分析、利益分析

### 7.2 中期拡張（6-12ヶ月）
- **Python移行**: サーバーサイド処理の強化
- **データベース連携**: 外部DBとの連携
- **AI機能**: 価格予測、在庫最適化

### 7.3 長期拡張（1年以上）
- **Webアプリ化**: 独立したWebアプリケーション
- **マルチプラットフォーム**: 複数ECサイト対応強化
- **自動化強化**: 完全自動在庫管理

## 8. 段階的実装計画

### Phase 1: 基盤構築（2-3週間）
**目標**: スクレイピングに依存しない安定した機能の実装

#### 1.1 データ構造の確定
- **在庫管理シート**の設計・作成
  - 商品情報、価格、在庫数の管理
  - 利益計算式の実装
  - 為替レート取得機能（GOOGLEFINANCE関数）
- **売上管理シート**の設計・作成
  - 注文データの入力フォーム
  - SKU/ASINによる在庫管理シートとの紐付け
  - 手数料計算・純利益算出
- **ルール管理シート**の設計・作成
  - 仕入れ元サイトのマスターデータ
  - 在庫判定ルールの管理
  - 手数料率の管理

#### 1.2 基本機能の実装
- **利益計算機能**
  - 仕入れ価格、販売価格、手数料を考慮した自動計算
  - 為替レート適用（ドル円換算）
- **Joom用CSV出力機能**
  - 在庫管理データからJoom形式CSVの自動生成
  - 未連携商品の識別とフィルタリング
  - 必須項目のバリデーション機能
  - ダウンロード機能の実装
- **データ入力・編集機能**
  - 商品情報の手動入力・編集
  - 売上データの入力・管理

#### 1.3 基本UIの構築
- **カスタムメニューの実装**
  - EC管理システムメニューの作成
  - 各機能へのアクセス方法の確立
- **入力インターフェースの作成**
  - 新商品追加用入力ウィンドウ
  - 注文データ入力用入力ウィンドウ
  - 各種設定用入力ウィンドウ
- **条件付き書式による視覚的表示**
  - 在庫ステータスによる色分け
  - 価格変動のハイライト表示

### Phase 2: スクレイピング実装（4-5週間）
**目標**: 段階的なスクレイピング機能の実装

#### 2.1 優先サイトの選定・実装（2週間）
**対象サイト候補**:
- **ヤフオク**: 構造が比較的単純、API制限が緩い
- **メルカリ**: 個人売買サイト、情報取得が容易
- **楽天市場**: 大手ECサイト、構造が安定

**実装内容**:
- 各サイトの商品ページ構造解析
- 在庫判定ロジックの実装
- 価格取得機能の実装
- エラーハンドリングの実装

#### 2.2 大手サイトへの対応（2-3週間）
**Amazon対応**:
- ASINコードによる商品識別
- 在庫確認機能（規約遵守）
- 価格取得機能
- アクセス制限への対応

**その他大手サイト**:
- Yahooショッピング
- その他指定サイト

#### 2.3 スクレイピング機能の統合
- 一括在庫チェック機能
- 定期実行機能（GASトリガー）
- エラー通知機能

### Phase 3: 通知・拡張機能（2-3週間）
**目標**: 価格変動通知と運用支援機能の実装

#### 3.1 価格変動通知機能
- **視覚的通知**: 条件付き書式による色分け
- **メール通知**: GASによる自動メール送信
- **価格履歴管理**: 変動履歴の記録・表示

#### 3.2 運用支援機能
- **ダッシュボード**: 売上・利益の可視化
- **レポート機能**: 月次・週次の売上分析
- **バックアップ機能**: データの自動バックアップ

### Phase 4: テスト・最適化（1-2週間）
**目標**: システムの安定性確保とパフォーマンス最適化

#### 4.1 総合テスト
- 全機能の動作確認
- エラーケースのテスト
- 複数ユーザーでの同時利用テスト

#### 4.2 パフォーマンス調整
- 大量データ処理の最適化
- GAS実行時間の最適化
- メモリ使用量の調整

### Phase 5: マニュアル作成・納品（1週間）
**目標**: 運用開始に向けたドキュメント整備

#### 5.1 操作マニュアル作成
- **基本操作マニュアル**: 日常的な操作方法
  - カスタムメニューの使い方
  - 新商品追加の手順
  - 在庫チェックの実行方法
  - CSV出力の手順
- **管理者マニュアル**: 設定変更・メンテナンス方法
  - 通知設定の変更
  - 定期チェック設定の管理
  - システム設定の変更
- **トラブルシューティング**: よくある問題と解決方法

#### 5.2 技術ドキュメント
- **システム構成書**: シート構成・GAS機能の説明
- **カスタマイズガイド**: 新規サイト追加方法
- **API連携準備**: 将来のSP-API対応に向けた設計書

#### 5.3 納品・引き渡し
- システムの最終確認
- クライアントへの操作方法説明
- サポート体制の確立

## 9. 実装における重要ポイント

### 9.1 Phase 1（基盤構築）の成功要因
- **データ構造の最適化**: 将来の拡張性を考慮した設計
- **利益計算の精度**: 全てのコスト要素を考慮した計算式
- **ユーザビリティ**: 直感的な操作インターフェース
- **エラーハンドリング**: データ入力時のバリデーション機能

### 9.2 Phase 2（スクレイピング）のリスク管理
- **段階的実装**: 簡単なサイトから順次対応
- **フォールバック機能**: スクレイピング失敗時の手動入力対応
- **アクセス制限対策**: 適切な間隔でのアクセス制御
- **サイト変更対応**: 構造変更時の迅速な対応体制

### 9.3 技術的考慮事項
- **GAS制限への対応**: 実行時間・API呼び出し制限の最適化
- **データ整合性**: 同時編集時の競合回避
- **パフォーマンス**: 大量データ処理時の最適化
- **セキュリティ**: 機密データの適切な管理

## 10. 確認事項

### 10.1 データ移行
- 既存在庫データの移行方法
- 移行データの形式・量
- データクレンジングの必要性

### 10.2 計算式詳細
- 利益計算の詳細式（送料、税金、ポイント等）
- 各ECサイトの手数料体系
- 為替レート適用タイミング

### 10.3 運用要件
- 想定商品点数・月間注文数
- 同時利用ユーザー数
- 通知メールの宛先・内容
- バックアップ・復旧要件

### 10.4 フォーマット
- Joom CSVアップロードフォーマット
  - 必須フィールド：Product SKU、Name、Description、Product Main Image URL、Store ID、Shipping Weight、Price、Currency、Inventory、Shipping Price
  - 推奨フィールド：Brand、Search Tags、Dangerous Kind、Suggested Category ID
  - データ変換：重量（g→kg）、価格（円→指定通貨）
- その他ECサイトのCSVフォーマット
- データエクスポート形式

### 10.5 優先実装サイト
- Phase 2で優先的に実装するサイトの選定
- 各サイトのアクセス頻度・重要度
- サイト固有の制約事項

---

**作成日**: 2025年9月
**バージョン**: 1.0
**作成者**: システム仕様書作成
